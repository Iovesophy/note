---
title: "AWS è«‹æ±‚é€šçŸ¥ BOT ã‚’ AWS Lambda + AWS SDK + Go ã§ä½œã‚‹ ~ å®Ÿè£…ç·¨ ~"
emoji: "ğŸ’¸"
type: "tech"
topics: [Go, AWS]
published: true
---

# AWS è«‹æ±‚é€šçŸ¥ BOT ã‚’ AWS Lambda + AWS SDK + Go ã§ä½œã‚‹ ~ å®Ÿè£…ç·¨ ~

## ã‚ã‚‰ã¾ã—

ä¸–ã®ä¸­ã« AWS è«‹æ±‚é¡ãŒè¨­å®šãƒŸã‚¹ã§å¤šé¡ã®è«‹æ±‚ãŒæ¥ã¦ã—ã¾ã£ãŸã¨ã„ã†äº‹æ•…ãŒå¤šã€…è¦‹å—ã‘ã‚‰ã‚Œã‚‹ã€ãã®å¯¾ç­–ã¨ã—ã¦ã€ç¾åœ¨ã®è«‹æ±‚é¡ã‚’é€šçŸ¥ã™ã‚‹ BOT ã‚’ä½œã‚‹ã®ã‚‚æœ‰åŠ¹ãªå¯¾ç­–æ‰‹æ®µã®ä¸€ã¤ã§ã‚ã‚‹ã€‚
å‰å› AWS Cost Explorer ã® SDK ã«é–¢ã—ã¦èª¿æŸ»ã‚’è¡Œã£ãŸã€‚

https://zenn.dev/_kazuya/articles/aeabc23cd5df2a

ä»Šå›ã¯ãã®ç¶šç·¨ã¨ã—ã¦ã€å®Ÿéš›ã«è«‹æ±‚é¡é€šçŸ¥ BOT ã®å®Ÿè£…ã‚’è¡Œãªã£ãŸã€‚

## æ§‹æˆ

ã¾ãšã¯å…¨ä½“ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹ãŸã‚ã«æ§‹æˆå›³ã‚’è¦‹ã¦ã„ã“ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/9fc188c6a97c-20220730.png)

### ä½¿ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€ã‚µãƒ¼ãƒ“ã‚¹

- Go
  - aws-sdk-go
  - aws-lambda-go
  - slack-go
  - go-chart
- AWS Lambda
- AWS SAM
- AWS SSM Parameter Store
- AWS CloudWatch Logs
- AWS Cost Explorer
- AWS EventBridge
- AWS S3
- open exchange rates API
- Slack API

### Lambda ã®æ§‹æˆã«ã¤ã„ã¦

- MainFunction
- GetCostFunction
- NotifyFunction
- PutRateFunction

### SSM Parameter Store ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¤ã„ã¦

![](https://storage.googleapis.com/zenn-user-upload/c11d00dab1f3-20220730.png)

1, /openexchangerates/JPY_RATE

- 1USD ãƒ™ãƒ¼ã‚¹ã®æ—¥æœ¬å††

2, /openexchangerates/APP_ID

- open exchange rates ã® API ã‚’å©ããŸã‚ã«å¿…è¦ãª APP_ID

3, /slack/APITOKEN

- Slack ã® APITOKEN

4, /slack/CHANNEL

- é€šçŸ¥ã—ãŸã„ Slack ãƒãƒ£ãƒ³ãƒãƒ«ã®åç§°

### EventBridge ã®è¨­å®šã«ã¤ã„ã¦

- æ¯æ—¥æ—¥æœ¬æ™‚é–“åˆå‰ 9:00 ã« MainFunction ã‚’å®Ÿè¡Œ
- æ¯æ—¥æ—¥æœ¬æ™‚é–“åˆå‰ 6:00 ã« PutRateFunction ã‚’å®Ÿè¡Œ

## SAM ã§ Lambda ã‚’ç«‹ã¦ã‚‹

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```tree:tree
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ invoke-obj
â”‚   â”œâ”€â”€ getcost
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ main
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ notify
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ putrate
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ pkg
â”‚   â”œâ”€â”€ aws
â”‚   â”‚   â””â”€â”€ sdk
â”‚   â”‚       â””â”€â”€ ce
â”‚   â”‚           â””â”€â”€ costandusage
â”‚   â”‚               â”œâ”€â”€ calc
â”‚   â”‚               â”‚   â””â”€â”€ sum.go
â”‚   â”‚               â”œâ”€â”€ getcost
â”‚   â”‚               â”‚   â””â”€â”€ getcost.go
â”‚   â”‚               â”œâ”€â”€ granularity
â”‚   â”‚               â”‚   â””â”€â”€ elem.go
â”‚   â”‚               â”œâ”€â”€ group
â”‚   â”‚               â”‚   â””â”€â”€ elem.go
â”‚   â”‚               â”œâ”€â”€ metric
â”‚   â”‚               â”‚   â””â”€â”€ elem.go
â”‚   â”‚               â””â”€â”€ term
â”‚   â”‚                   â”œâ”€â”€ elem.go
â”‚   â”‚                   â””â”€â”€ term.go
â”‚   â””â”€â”€ openexchangerates
â”‚       â””â”€â”€ getrates.go
â”œâ”€â”€ renew.yaml
â””â”€â”€ template.yaml

```

SAM ã‚„ Lambda ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚ç…§ã›ã‚ˆã€‚

https://docs.aws.amazon.com/ja_jp/serverless-application-model/latest/developerguide/serverless-getting-started-hello-world.html

### GetCostFunction ã‚’å®Ÿè£…ã—ã‚ˆã†

ã¾ãšã€AWS SDK æ¥ç¶šç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚

https://docs.aws.amazon.com/sdk-for-go/api/aws/session/

```Go:main.go
const Region = "ap-northeaset-1"
sess := session.Must(session.NewSessionWithOptions(session.Options{
    Config: aws.Config{
        Region: aws.String(Region),
    },
    SharedConfigState: session.SharedConfigEnable,
}))
```

ä»Šå›ã¯ã€ `session` ã® ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ `Config` ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹ã€‚
ã¾ãŸã€ `SharedConfigState` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ç’°å¢ƒå¤‰æ•°(AWS_SDK_LOAD_CONFIG)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã«å½¹ç«‹ã¤ã€‚

```bash:terminal
$ sam local invoke GetCostFunction
```

`aws.String` ã«ç–‘å•ã‚’æŒãŸã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ã“ã‚Œã¯å˜ã«æ¸¡ã—ãŸæ–‡å­—åˆ—ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã™ã ã‘ã®ä¾¿åˆ©é–¢æ•°ã§ã‚ã‚‹ã€‚

```Go:convert_types.go
// String returns a pointer to the string value passed in.
func String(v string) *string {
	return &v
}
```

https://github.com/aws/aws-sdk-go/blob/main/aws/convert_types.go

æ¬¡ã«ã€AWS Cost Explorer ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®£è¨€ã™ã‚‹ã€‚
å®£è¨€æ™‚ã«å…ˆç¨‹ãƒã‚¤ãƒ³ãƒ‰ã—ãŸ `sess` ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã€‚

```Go:main.go
svce := costexplorer.New(sess)
```

ä»Šåº¦ã¯ã€æŒ‡å®šã—ãŸæœŸé–“ã®é‡‘é¡ã‚’ AWS Cost Explorer ã‹ã‚‰å–å¾—ã™ã‚‹ã€‚
ã‚ã‚‰ã‹ã˜ã‚ã€ `pkg` ã«ã¦å®Ÿè£…ã—ã¦ãŠã„ãŸã€å®Ÿè¡Œã—ãŸæœˆã®åˆæ—¥ã‹ã‚‰å®Ÿè¡Œæ—¥ã®å‰æ—¥ã¾ã§ã®æœŸé–“ã‚’ `start` ã€ `end` ã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã€‚
ã¾ãŸã€ getcost ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `c` ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ãŠãã€‚
GetCost é–¢æ•°ã‚’ `c` ã‹ã‚‰å‘¼ã³å‡ºã—ã€å…ˆç¨‹å®£è¨€ã—ãŸ `svce` ã¨ã€ `start` ã€ `end` ã‚’æ¸¡ã—ã¦ã‚³ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã€‚

```Go:main.go
// The start date is inclusive, but the end date is exclusive.
start, end, _ := term.CreateThisMonthRange(jst)
c := getcost.Params{}
cost, err := c.GetCost(svce, start, end)
```

`CreateThisMonthRange` é–¢æ•°ã«é–¢ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸã€‚

```Go:pkg/aws/sdk/ce/costandusage/term/term.go
package term

import (
	"time"

	"github.com/aws/aws-sdk-go/aws"
)

func beginningOfMonth(day time.Time) time.Time {
	return time.Date(day.Year(), day.Month(), 1, 0, 0, 0, 0, day.Location())
}

func CreateThisMonthRange(zone *time.Location) (*string, *string, string) {
	now := time.Now().UTC().In(zone)
	start := beginningOfMonth(now)
	end := now

	s := start.Format(Format.String())
	e := end.Format(Format.String())

	// The start date is inclusive, but the end date is exclusive.
	// https://docs.aws.amazon.com/ja_jp/aws-cost-management/latest/APIReference/API_GetCostAndUsage.html
	p := end.AddDate(0, 0, -1).Format(Format.String())
	return aws.String(s), aws.String(e), p
}
```

`GetCost` é–¢æ•°ã«é–¢ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸã€‚

```Go:pkg/aws/sdk/ce/costandusage/getcost/getcost.go
func (c Params) GetCost(svc costexploreriface.CostExplorerAPI, start *string, end *string) (*costexplorer.GetCostAndUsageOutput, error) {
	c.Granularity = granularity.Monthly.String()

	c.Metrics = []*string{
		metric.UnblendedCost.String(),
	}

	c.Term = &costexplorer.DateInterval{
		Start: start,
		End:   end,
	}

	service := costexplorer.GroupDefinition{
		Key:  group.Service.Key(),
		Type: group.Dimention.Type(),
	}
	c.Groups = append(c.Groups, &service)

	input := costexplorer.GetCostAndUsageInput{
		Granularity: c.Granularity,
		TimePeriod:  c.Term,
		Metrics:     c.Metrics,
		GroupBy:     c.Groups,
	}

	result, err := svc.GetCostAndUsage(&input)
	if err != nil {
		return nil, err
	}
	return result, nil
}
```

ã¾ãŸã€`GetCost` ã‚’ã¯ã˜ã‚ã¨ã—ãŸã€å„ç¨®é–¢æ•°å†…ã«å±•é–‹ã•ã‚Œã‚‹ãƒªãƒ†ãƒ©ãƒ«ã«é–¢ã—ã¦ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ `elem.go` ã«åˆ†é›¢ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®£è¨€ã—ãŸã€‚

å®Ÿè£…ä¾‹ã¨ã—ã¦ã€`granularity/elem.go` ã‚’ä»¥ä¸‹ã«æç¤ºã™ã‚‹ã€‚

```Go:pkg/aws/sdk/ce/costandusage/granularity/elem.go
package granularity

import "github.com/aws/aws-sdk-go/aws"

type CE int

const (
	Daily CE = iota
	Monthly
	Hourly
)

func (ce CE) String() *string {
	switch ce {
	case Daily:
		return aws.String("DAILY")
	case Monthly:
		return aws.String("MONTHLY")
	case Hourly:
		return aws.String("HOURLY")
	default:
		return nil
	}
}
```

æ¬¡ã«ã€AWS SSM Parameter Store ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®£è¨€ã™ã‚‹ã€‚
`sess` ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã€‚

```Go:main.go
svc := ssm.New(sess)
```

å¾Œè¿°ã™ã‚‹ãŒã€ã‚ã‚‰ã‹ã˜ã‚ã€PutRateFunction ã«ã¦ open exchange rates API ã§å–å¾—ã—ãŸ 1USD ãƒ™ãƒ¼ã‚¹ã®æ—¥æœ¬å††ã‚’ AWS SSM Parameter Store ã‹ã‚‰å–å¾—ã™ã‚‹ã€‚
ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æš—å·åŒ–ã®å¿…è¦ãŒãªã„ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å‡¦ç†ã™ã‚‹ã€‚
ã“ã®å ´åˆ `WithDecryption` ã‚’ `false` ã«è¨­å®šã™ã‚‹ã€‚

```Go:main.go
rawjpy, err := svc.GetParameter(&ssm.GetParameterInput{
    Name:           aws.String("/openexchangerates/JPY_RATE"),
    WithDecryption: aws.Bool(false),
})
```

ã¾ãŸã€SSM Parameter Store ã‹ã‚‰å–å¾—ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `String` å‹ã§è¿”ã£ã¦ãã‚‹ã®ã§ã€`Float` å‹ã«ã‚³ãƒ³ãƒãƒ¼ãƒˆãŒå¿…è¦ã€‚

```Go:main.go
jpy, err := strconv.ParseFloat(*rawjpy.Parameter.Value, 64)
```

æœ€å¾Œã« Lambda ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ã€å€¤ã‚’è¿”å´ã™ã‚‹ã€‚

```Go:main.go
return Response{
        Message: Succcess,
        Cost:    cost,
        Rate:    jpy,
    },
    nil
```

### PutRateFunction ã‚’å®Ÿè£…ã—ã‚ˆã†

AWS SDK ã®é€šä¿¡ç”¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ `sess` ã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã€‚
ä¸Šè¿°ã—ãŸã®ã§å‰²æ„›ã™ã‚‹ã€‚

æ¬¡ã«ã€ã‚ã‚‰ã‹ã˜ã‚å®Ÿè£…ã—ã¦ãŠã„ãŸã€ `PutOpenexchangeratesJpy` é–¢æ•°ã‚’ç”¨ã„ã¦ AWS SSM Parameter Store ã« 1USD ãƒ™ãƒ¼ã‚¹ã® JPY ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¹ãƒˆã‚¢ã™ã‚‹ã€‚

```Go:main.go
// Put Base of USD JPY Rate to ssm parameter store with OpenExchangeRates API
if err := openexchangerates.PutOpenexchangeratesJpy(sess); err != nil {
    return Response{
            Message: ErrPutOpenExchangeRates,
        },
        err
}
```

`PutOpenexchangeratesJpy` é–¢æ•°ã«é–¢ã—ã¦ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸã€‚

```Go:pkg/openexchangerates/getrates.go
func PutOpenexchangeratesJpy(sess *session.Session) error {
	// Base URL: see https://docs.openexchangerates.org
	base := "https://openexchangerates.org/api/latest.json?app_id=%s"
	// Application id: https://docs.openexchangerates.org/docs/authentication
	// Using ssm parametor store: https://ap-northeast-1.console.aws.amazon.com/systems-manager/parameters
	svc := ssm.New(sess)
	app_id, err := svc.GetParameter(&ssm.GetParameterInput{
		Name:           aws.String("/openexchangerates/APP_ID"),
		WithDecryption: aws.Bool(true),
	})
	if err != nil {
		return err
	}
	// Create Request url
	url := fmt.Sprintf(base, *app_id.Parameter.Value)

	// Start Request
	resp, err := http.Get(url)
	if err != nil {
		return err
	}
	defer resp.Body.Close()

	source, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		return err
	}

	// Parse json
	desc := Schema{}
	json.Unmarshal(source, &desc)

	// Cache rates in ssm parametor store
	cache := strconv.FormatFloat(desc.Rates.JPY, 'f', 2, 64)
	svc.PutParameter(&ssm.PutParameterInput{
		Name:      aws.String("/openexchangerates/JPY_RATE"),
		Value:     aws.String(cache),
		Overwrite: aws.Bool(true),
	})
	if err != nil {
		return err
	}
	return nil
}
```

è§£èª¬ã™ã‚‹ã¨ã€ã¾ãšã€AWS SSM Parameter Store ã‹ã‚‰ open exchange rates API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ã€‚

ãƒ¬ãƒ¼ãƒˆå–å¾—ã«ã¯ open exchange rates ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚

ã‚ã‚‰ã‹ã˜ã‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ã€ AWS SSM Parameter Store ã«æ ¼ç´ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

- [open exchange rates URL](https://openexchangerates.org/) ã«ã‚¢ã‚¯ã‚»ã‚¹
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
- Integration -> App IDs ã«ã‚¢ã‚¯ã‚»ã‚¹
- Generate New App ID ã‚’ã‚¯ãƒªãƒƒã‚¯
- ã€ŒApp IDã€ãŒ API key ãªã®ã§ã€ã“ã¡ã‚‰ã‚’ã‚³ãƒ”ãƒ¼
- API key ã‚’ SSM Parameter Store ã«è¨­å®šã—ã¦å®Œäº†

ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã«é–¢ã—ã¦ã¯ã€ã‚»ã‚­ãƒ¥ã‚¢ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€å¾©å·ãŒå¿…è¦ã¨ãªã‚‹ã€‚
ãã®ãŸã‚ã€`WithDecryption` ã‚’ `true` ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

æ¬¡ã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å«ã‚“ã ã‚¢ã‚¯ã‚»ã‚¹ URL ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€`fmt` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® `Sprintf` é–¢æ•°ã‚’ä½¿ã£ã¦ `url` ã¸ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã„ã‚‹ã€‚
ã“ã® `url` ã‚’ä½¿ã£ã¦ http get ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’èª­ã¿è¾¼ã‚“ã§ Json ã‚’æ§‹é€ ä½“ `Schema` ã¸ Unmarshal ã™ã‚‹ã€‚

```Go:Schema
type Schema struct {
	Rates Rate `json:"rates"`
}

type Rate struct {
	JPY float64 `json:"JPY"`
}
```

æœ€å¾Œã«å–å¾—ã§ããŸãƒ¬ãƒ¼ãƒˆã‚’ AWS SSM Parameter Store ã«ä¸Šæ›¸ãã—ã¦å®Œäº†ã€‚

### NotifyFunction ã‚’å®Ÿè£…ã—ã‚ˆã†

ä»Šå›ã€é€šçŸ¥å…ˆã‚’ Slack ã«ã—ãŸã„ã®ã§ã€ Slack API ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

#### Slack API ã®æ‰‹ç¶šãæ–¹æ³•

- Slack ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒOAuth & æ¨©é™ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
- ã€Œãƒœãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—ã€ã«ã‚ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å°‘ãªãã¨ã‚‚ 1 ã¤é¸æŠã—ãŸã‚‰ã€ã€ŒOAuth ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¿½åŠ ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒApp Homeã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è¿½åŠ ã—ãŸãƒœãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¨­å®šã‚’ç¢ºèª
- å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ AWS SSM Parameter Store ã«è¨­å®š
- é€šçŸ¥ã—ãŸã„ãƒãƒ£ãƒ³ãƒãƒ«åã‚’ AWS SSM Parameter Store ã«è¨­å®š

å„ç¨®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ AWS SSM Parameter Store ã«æ ¼ç´ã§ããŸã‚‰æ¬¡ã¯ã€Lambda ã‚’ç«‹ã¦ã‚‹ã€‚

ã¾ãšã€ä¸Šè¿°ã—ãŸ Lambda é–¢æ•°ã‹ã‚‰ NotifyFunction ã«å€¤ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ãŒã€ãã®éš›ã€å€¤å–å¾—çŠ¶æ³ã«ã‚ˆã£ã¦é€šçŸ¥å¯èƒ½ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

event ã‹ã‚‰å€¤ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€å—ã‘å–ã‚ŠãŸã„å€¤ã‚’ã€æ§‹é€ ä½“ Event ã¨ã—ã¦å®šç¾©ã™ã‚‹ã€‚

```Go:main.go
type Event struct {
	Cost *costexplorer.GetCostAndUsageOutput
	Rate float64
}
```

æ¬¡ã«ã€AWS Cost Explorer ã‹ã‚‰å–å¾—ã—ãŸå€¤ã¨ã€ open exchange rates ã‹ã‚‰å€¤ã‚’å–å¾—ã§ãã¦ã„ãªã„å ´åˆã¯ nil åŠã³ ã‚¼ãƒ­å€¤ ãªãŸã‚ã€ãã®å€¤ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚

```Go:main.go
func handler(event Event) (Response, error) {
	// Check event value
	if event.Cost == nil || event.Rate == 0 {
		return Response{
				Message: ErrEvent,
			},
			nil
	}
~ ommit
```

ã¾ãŸã€é€šçŸ¥æ™‚ã«è¡¨ç¤ºç”¨ã®æœŸé–“ã‚’æ”¹ã‚ã¦è¨ˆç®—ã™ã‚‹ã€‚

```Go:main.go
start, _, endexclusivedate := term.CreateThisMonthRange(jst)
```

æ¬¡ã«ã€é€šçŸ¥ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œã£ã¦ã„ãã€‚

```Go:main.go
// Create Notify Contents
var notifyText string
var list []chart.Value
for _, group := range event.Cost.ResultsByTime[0].Groups {
    label := *group.Keys[0]
    amount, err := strconv.ParseFloat(*group.Metrics[*metric.UnblendedCost.String()].Amount, 64)
    if err != nil {
        return Response{
                Message: ErrParseAmount,
            },
            err
    }
    // Create Text
    text := fmt.Sprintf("ãƒ» %s: %.2f å††\n", label, amount*event.Rate)
    notifyText += text
    // Create GraphList
    // Avoid strings longer than 12 characters that cannot be drawn correctly with go-chart
    if len(label) > 10 && !strings.Contains(label, " ") {
        label = label[:11] + " " + label[11:]
    }
    list = append(list, chart.Value{
        Value: amount * event.Rate,
        Label: label,
    })
}
// Create Title
total := calc.Sum(event.Cost, event.Rate)
notifyTitle := fmt.Sprintf("%s ã€œ %s ã®è«‹æ±‚é¡(1 USD = %.2f JPYã§è¨ˆç®—)\n%s", *start, endexclusivedate, event.Rate, total)
```

ã“ã“ã§ã€ `calc.Sum`ã€€ã«é–¢ã—ã¦ã ãŒã€ ç·é¡ã‚’ AWS Cost Explorer ã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ 2 å›è¡Œã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ãŸã‚ã€ Lambda é–¢æ•°å†…ã§è¨ˆç®—ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

```Go:pkg/aws/sdk/ce/costandusage/calc/sum.go
func Sum(cost *costexplorer.GetCostAndUsageOutput, jpy float64) (total string) {
	var sum float64
	for _, c := range cost.ResultsByTime[0].Groups {
		amount, _ := strconv.ParseFloat(*c.Metrics["UnblendedCost"].Amount, 64)
		sum += amount
	}
	total = fmt.Sprintf("â–· Total: %.2f å††", sum*jpy)
	return total
}
```

ã•ã¦ã€é€šçŸ¥éƒ¨åˆ†ã‚’æ›¸ã„ã¦ã„ã“ã†ã€‚

ã¾ãšã€ AWS SSM Parameter Store ã‹ã‚‰ã€ Slack API ã«å¿…è¦ãªã‚¢ã‚¯ã‚»ã‚¹ TOKEN ã¨ CHANNEL åã‚’å–å¾—ã™ã‚‹ã€‚

- Slack APITOKEN

```Go:main.go
// Post Message
// Create SSM session
svc := ssm.New(sess)
// Get Paramater from ssm
SLACKAPITOKEN, err := svc.GetParameter(&ssm.GetParameterInput{
    Name:           aws.String("/slack/APITOKEN"),
    WithDecryption: aws.Bool(true),
})
```

- Slack CHANNEL å

```Go:main.go
// Get Paramater from ssm
SLACKCHANNEL, err := svc.GetParameter(&ssm.GetParameterInput{
    Name:           aws.String("/slack/CHANNEL"),
    WithDecryption: aws.Bool(false),
})
```

æ¬¡ã«ã€Slack ã® Session ã‚’ä½œæˆã™ã‚‹ã€‚

```Go:main.go
// Creat session of Slack
api := slack.New(*SLACKAPITOKEN.Parameter.Value)
```

Slack API ã® Attachement æ§‹é€ ä½“ã«é€šçŸ¥ã—ãŸã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```Go:main.go
attachment := slack.Attachment{
    Pretext: notifyTitle,
    Text:    notifyText,
}
```

é€šçŸ¥ã‚’è¡Œã†ã€‚

```Go:main.go
_, _, err = api.PostMessage(
    *SLACKCHANNEL.Parameter.Value,
    slack.MsgOptionAttachments(attachment),
    slack.MsgOptionAsUser(true),
)
```

#### ãŠã¾ã‘

é‡‘é¡ã®é€šçŸ¥ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§è¡Œãªã£ãŸãŒã€ã›ã£ã‹ããªã®ã§ã‚°ãƒ©ãƒ•ã‚‚ä½œã£ã¦é€šçŸ¥ã—ã¦ã¿ãŸã„ã€‚

AWS CloudWatch ãªã©ã‚’ä½¿ãˆã°ã€ã‚°ãƒ©ãƒ•ã‚’å–å¾—ã§ããŸã‚Šã™ã‚‹ãŒã€ä»Šå›ã¯ JPY ã«å¤‰æ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã€è‡ªå‰ã§ã‚°ãƒ©ãƒ•ã‚’ç”¨æ„ã™ã‚‹ã€‚

ã‚°ãƒ©ãƒ•ç”Ÿæˆã«ã¯ã€ `go-chart` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ãŸã€‚

ã¾ãšã€ã‚°ãƒ©ãƒ•ç”Ÿæˆã®éš›ã«ã€æç”»å¯èƒ½ãªä¸Šé™ã€ä¸‹é™ã‚’å®šã‚ã‚‹ã€‚

AWS ã®ã‚µãƒ¼ãƒ“ã‚¹æ•°ã¯ãŠãŠã‚ˆã 200 ç¨‹åº¦ãªã®ã§ã€åˆ©ç”¨ã‚µãƒ¼ãƒ“ã‚¹ 1 ~ 200 ä»¶ã‚’æç”»ã§ãã‚‹ç¯„å›²ã¨ã™ã‚‹ã€‚

```Go:main.go
// Create Graph
if len(list) >= 200 || len(list) <= 1 {
    return Response{
        Message: ErrPost,
    }, errors.New("Can't plot graph")
}
```

æ¬¡ã«ã‚°ãƒ©ãƒ•ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ±ºã‚ã‚‹ã€‚
ä»Šå›ã¯æ£’ã‚°ãƒ©ãƒ•ã¨ã—ã¦ã€æç”»ã™ã‚‹ã€‚

ã“ã“ã‚‰è¾ºã¯å¥½ã¿ã®å•é¡Œã«ãªã‚‹ã¨æ€ã†ã®ã§ã€å‚è€ƒç¨‹åº¦ã«å®Ÿè£…ä¾‹ã‚’ä»¥ä¸‹ã«æç¤ºã™ã‚‹ã€‚

```Go:main.go
baseHeight, baseWidth := 100, 100
if len(list) <= 5 {
    baseHeight, baseWidth = 200, 200
}
graph := chart.BarChart{
    Title: "AWS Price per Service",
    Background: chart.Style{
        Padding: chart.Box{
            Top: 50,
        },
    },
    Height:   len(list) * baseHeight / 2,
    Width:    len(list) * baseWidth,
    BarWidth: 90,
    Bars:     list,
}
```

ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ±ºã‚ãŸã‚‰ã€ã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã€‚

```Go:main.go
buf := bytes.NewBuffer([]byte{})
err = graph.Render(chart.PNG, buf)
```

æœ€å¾Œã«ã€å†åº¦ Slack API ã‚’ç”¨ã„ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸã‚°ãƒ©ãƒ•ã‚’é€ä¿¡ã—ã¦å®Œäº†ã€‚

```Go:main.go
// Post Graph
_, err = api.UploadFile(
    slack.FileUploadParameters{
        Reader:   buf,
        Filename: "awscost-" + endexclusivedate + ".png",
        Channels: []string{*SLACKCHANNEL.Parameter.Value},
    })
```

### MainFunction ã‚’å®Ÿè£…ã—ã‚ˆã†

ãã‚Œãã‚Œæ©Ÿèƒ½ã”ã¨ã« Lambda ã‚’åˆ†é›¢ã—ãŸã®ã§ã€ `MainFunction` ã¨ã„ã† Lambda ã‚’ç«‹ã¦ã¦ã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ç”¨ã®é–¢æ•°ã‚’ç«‹ã¦ã‚‹ã€‚
ä»Šå›ã¯ã€ Lambda ã‚’ç«‹ã¦ã‚‹ãŒã€StepFunctions ãªã©ã‚’åˆ©ç”¨ã—ã¦ã‚‚è‰¯ã„ã ã‚ã†ã€‚

ã¾ãšã€ãã‚Œãã‚Œæ©Ÿèƒ½ã”ã¨ã® Lambda ã‚’å‘¼ã³å‡ºã™éš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®æ§‹é€ ä½“ã‚’å®šç¾©ã™ã‚‹ã€‚

```Go:main.go
type getCostItemsResponse struct {
	Message string                              `json:"message"`
	Cost    *costexplorer.GetCostAndUsageOutput `json:"cost"`
	Rate    float64                             `json:"rate"`
}

type getNotifyItemsRequest struct {
	Cost *costexplorer.GetCostAndUsageOutput
	Rate float64
}

type getNotifyItemsResponse struct {
	Message string `json:"message"`
}
```

æµã‚Œã¨ã—ã¦ã¯ã€AWS Cost Explorer ã€ open exchange rates ã‚’åˆ©ç”¨ã—ã¦å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ GetCostFunction é–¢æ•°ã‹ã‚‰å—ã‘å–ã‚‹ã€‚
æ¬¡ã«ã€NotifyFunction ã«å—ã‘å–ã£ãŸå€¤ã‚’æ¸¡ã™ã€‚
æœ€å¾Œã« ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã®çµæœã‚’å—ã‘å–ã‚‹ã€‚

Lambda é–¢æ•°å†…ã‹ã‚‰ Lambda é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã«ã¯ã€`aws-lambda-go` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

ã¾ãšã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®£è¨€ã™ã‚‹ã€‚

```Go:main.go
svcl := lambda.New(sess)
```

- GetCostFunction ã‚’ Invoke ã™ã‚‹ã€‚

```Go:main.go
// Invoke getcostfunction
result, err := svcl.Invoke(
    &lambda.InvokeInput{
        FunctionName: aws.String("GetCostFunction"),
    },
)
var getcostresp getCostItemsResponse
err = json.Unmarshal(result.Payload, &getcostresp)
```

ã¾ãšã€Invoke ã—ãŸã„ Lambda é–¢æ•°åã‚’ `InvokeInput` æ§‹é€ ä½“ã® `FunctionName` ã«è¨­å®šã€‚
å—ã‘å–ã£ãŸ `Payload` ã‚’å…ˆç¨‹ç”¨æ„ã—ãŸ `getCostItemsResponse` æ§‹é€ ä½“ã¸ Unmarshal ã™ã‚‹ã€‚

- NotifyFunction ã‚’ Invoke ã™ã‚‹ã€‚

```Go:main.go
// Invoke notifyfunction
request := getNotifyItemsRequest{
    Cost: getcostresp.Cost,
    Rate: getcostresp.Rate,
}
payload, _ := json.Marshal(request)
result, err = svcl.Invoke(
    &lambda.InvokeInput{
        FunctionName: aws.String("NotifyFunction"),
        Payload:      payload,
    },
)
var notifyresp getNotifyItemsResponse
err = json.Unmarshal(result.Payload, &notifyresp)
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æ¸¡ã—ãŸã„å€¤ã‚’ã€€`Payload` ã«ã‚»ãƒƒãƒˆã—ã¦ã€Lambda é–¢æ•°ã‚’ Invoke ã™ã‚‹ã€‚
åŒæ§˜ã«ã€Invoke ã—ãŸã„ Lambda é–¢æ•°åã‚’ `InvokeInput` æ§‹é€ ä½“ã® `FunctionName` ã«è¨­å®šã€‚
å—ã‘å–ã£ãŸ `Payload` ã‚’å…ˆç¨‹ç”¨æ„ã—ãŸ `getCostItemsResponse` æ§‹é€ ä½“ã¸ Unmarshal ã™ã‚‹ã€‚

ä»¥ä¸Šã§é€šçŸ¥ BOT ã®å®Ÿè£…ã¯å®Œäº†ã€‚

`sam local invoke` ã‚³ãƒãƒ³ãƒ‰ç­‰ã§ãƒ†ã‚¹ãƒˆã§ãã‚‹ã€‚

â€»æ³¨æ„ç‚¹

- ä»Šå›ã¯è§£èª¬ã®éš›ã®è¦‹é€šã—ã‚’è‰¯ãã™ã‚‹ãŸã‚ã« ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’çœã„ã¦è§£èª¬ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ãŒã€ãã¡ã‚“ã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æ›¸ãã“ã¨ã€‚

## Lambda é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

å„ Lambda é–¢æ•°ã®å®Ÿè£…ãŒã§ããŸã‚‰ã€æ¬¡ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã ã€‚

template.yaml ã‚’è¨˜è¿°ã—ã‚ˆã†ã€‚

ä»Šå›ã¯ AWS SAM ã‚’ä½¿ã†ã®ã§ã€ Transform ã‚’è¨­å®šã™ã‚‹ã“ã¨ã€‚

æ¬¡ã«ãã‚Œãã‚Œã®é–¢æ•°ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é©å½“ã« 20 sec ã«è¨­å®šã€‚
ä»Šå›ã¯å‰²æ„›ã™ã‚‹ãŒã€ãã‚Œãã‚Œã® Lambda é–¢æ•°å†…ã«é©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚‚è¨­å®šã™ã‚‹ã“ã¨ã€‚

```yaml:template.yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    Timeout: 20
```

æ¬¡ã«ã€`Resorces` ã‚’å®šç¾©ã™ã‚‹ã€‚

```yaml:template.yaml
Resources:
```

ã¾ãšã€ MainFunction ã® IamRole ã‚’å®šç¾©ã™ã‚‹ã€‚
MainFunction å†…ã§å‘¼ã³å‡ºã™ Lambda é–¢æ•°ã¯ã€€ GetCostFunction ã¨ã€€ NotifyFunction ãªã®ã§ã€Resorce ã«ãã‚Œãã‚Œã®é–¢æ•°ã® ARN ã‚’æŒ‡å®šã™ã‚‹ã€‚

```yaml:template.yaml
  MainFunctionIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: "MainFunctionLambdaPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "lambda:InvokeFunction"
                Resource:
                  - !GetAtt GetCostFunction.Arn
                  - !GetAtt NotifyFunction.Arn

```

ã¾ãŸã€AWS CloudWatch logs ã«ãƒ­ã‚°ã‚’æ›¸ãå‡ºã—ãŸã„ãŸã‚ã€è¿½åŠ ã§ `WriteLimitedAccessToCloudWatch` Policy ã‚’å®šç¾©ã—ã¦ãŠãã€‚

```yaml:template.yaml
        - PolicyName: "WriteLimitedAccessToCloudWatch"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - arn:aws:logs:ap-northeast-1:<ommit>:log-group:*
```

ã“ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã«ã¯ GetCostFunction ã¨ NotifyFunction ã® ARN ãŒå­˜åœ¨ã—ãªã„ã¨é©åˆ‡ã«ä½œæˆã§ããªã„ã®ã§ã€ `DependsOn` ã®è¨­å®šã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã€‚

```yaml:template.yaml
    DependsOn:
      - GetCostFunction
      - NotifyFunction
```

æ¬¡ã«ã€Lambda æœ¬ä½“ã§ã‚ã‚‹ã€ MainFunction ã‚’å®šç¾©ã™ã‚‹ã€‚

```yaml:template.yaml
  MainFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: MainFunction
      CodeUri: invoke-obj/main
      Handler: app.lambda_handler
      Runtime: go1.x
      Architectures:
        - x86_64
      Role: !GetAtt MainFunctionIamRole.Arn
      Events:
        Main:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 ? * * *) #09:00JST,Everyday.
  MainFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${MainFunction}
      RetentionInDays: 30
```

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«é–¢æ•°åã¨ã€ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã€ä»Šå›ã¯ Go ã§å®Ÿè£…ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã« `go1.x` ã‚’æŒ‡å®šã€‚

`Role` ã«ã¯ã€å…ˆç¨‹å®šç¾©ã—ãŸ MainFunctionIamRole ã® ARN ã‚’æŒ‡å®šã™ã‚‹ã€‚

`Events` ã«ã¯ã€ä»Šå›ã€æ¯æ—¥æ—¥æœ¬æ™‚é–“ AM 9:00 ã«é€šçŸ¥ã‚’è¡Œã†ãŸã‚ã€ `Schedule` éƒ¨åˆ†ã« `Cron` å¼ã‚’è¨˜è¿°ã™ã‚‹ã€‚

ã¾ãŸã€LogGroup ã‚’å®šç¾©ã—ã¦ã€é–¢æ•°ã”ã¨ã«ãƒ­ã‚°ã‚’åˆ†ã‘ã‚‹ã€‚
`RetentionInDays` ã‚’è¨­å®šã—ã¦ã€ä¸€ãƒ¶æœˆã®ã¿ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’è¨˜è¿°ã—ã¦ãŠã“ã†ã€‚

ä»¥ä¸Šã®è¦é ˜ã§ã€æ®‹ã‚Šã® GetCostFunction ã€ PutRateFunction ã€ NotifyFunction ã‚’å®šç¾©ã—ã‚ˆã†ã€‚

ä»Šå›ã¯æ¯”è¼ƒçš„æ‰‹è»½ã«ä½¿ç”¨ã§ãã‚‹ AWS CLI ã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚

ã¾ãšã€template.yaml ã«æ–‡æ³•çš„ãªé–“é•ã„ãŒãªã„ã‹ `validate` ã‚’ä½¿ã£ã¦ç¢ºèªã™ã‚‹ã€‚

```Makefile:Makefile
.PHONY: valid
valid:
	sam validate -t template.yaml
```

æ¬¡ã«ã€`sam build` ã§ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
ã¾ãŸã€CodeUri ã‚’ S3 ã«æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€åˆ¥é€” template ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ãã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```Makefile:Makefile
.PHONY: package
package:
	sam package --output-template-file renew.yaml --s3-bucket <hoge>
```

æœ€å¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ã€‚ä»Šå›ã¯ IAM Role ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ `CAPABILITY_IAM` ã‚’æŒ‡å®šã™ã‚‹ã€‚

```Makefile:Makefile

.PHONY: deploy
deploy: package
	sam deploy --template-file renew.yaml --stack-name <hoge> --capabilities CAPABILITY_IAM --region ap-northeast-1
```

ä»¥ä¸Šã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã€‚

- é€šçŸ¥ã®æ§˜å­

![](https://storage.googleapis.com/zenn-user-upload/da3f152bc44f-20220731.png)

# ã¾ã¨ã‚

ä»Šå›ã¯ Lambda é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§è¡Œã£ãŸã€‚

AWS ã‚’åˆ©ç”¨ã—ãŸã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆæ™‚ã€ã‚ã‚‹ç¨‹åº¦æ­£ã—ã„è¦‹ç©ã‚‚ã‚ŠãŒã§ããªã„ã¨å¤§ããªæå®³ã‚’ç”Ÿã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ä¿¡ç”¨ã‚’å¤±ã†ã“ã¨ã«ãªã‚Šã‹ã­ãªã„ã€‚
æ—¥ã€… BOT ç­‰ã‚’æ´»ç”¨ã—ã€é–¢ä¿‚è€…ã«é€šçŸ¥ã‚’é€ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è²¬ä»»ã‚’åˆ†æ•£ã•ã›ã¦ã„ã‘ã‚Œã°è‰¯ã„ãªã¨æ€ã†ã€‚

æ¬¡å›ã¯ã€CI/CD ç·¨ã‚’æ›¸ãäºˆå®šã€‚
