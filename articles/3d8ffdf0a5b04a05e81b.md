---
title: "golangã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’åŠ¹ç‡çš„ã«ç¢ºèªã™ã‚‹"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["golang","Makefile","Docker"]
published: true
---

# golangã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’åŠ¹ç‡çš„ã«ç¢ºèªã™ã‚‹

å‰å›ã®è¨˜äº‹ã§ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’shellã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã—ã¦ãã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ç¢ºèªã—ã¦ã„ã¾ã—ãŸã€‚
https://zenn.dev/_kazuya/articles/f6e89eeab197d52067d7

ä»Šå›ã“ã‚Œã‚’Dockerfileã¨Makefileã«ã¾ã¨ã‚ã¦ã‚ˆã‚Šãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ã‚„ã™ã„ã‚ˆã†ã«ã—ãŸãƒ¡ãƒ¢ã€‚

# æµã‚Œ

+ ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®stage1ã«ãŠã„ã¦ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®cover.outãªã©ã‚’ç”Ÿæˆã™ã‚‹
+ stage2ã«ãŠã„ã¦ã€stage1ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
+ Dockerã‚³ãƒ³ãƒ†ãƒŠãƒ¼ãªã„ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€cover.outã‚’htmlã«ã‚³ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
+ Makefileã§å„ç¨®ã‚³ãƒãƒ³ãƒ‰ã‚’ã¾ã¨ã‚ã‚‹


## ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹Dockerfileã‚’è¨˜è¿°ã—ç›´ã™ã€‚

```docker:Dockerfile
FROM golang:latest AS stage1-buildphase
WORKDIR /go/src
COPY . .
RUN go test main_test.go main.go -v
RUN go build -o tail main.go
RUN go test main_test.go main.go -coverprofile=cover.out
RUN go tool cover -html=cover.out -o convert.html

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root
COPY --from=stage1-buildphase /go/src/ .
CMD ["./start.sh"]
```

ã“ã“ã§ç”Ÿæˆã•ã‚Œã‚‹convert.htmlã¯ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã«ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/g411uv4kwai1n41037jniytlxuo6)

## Makefileã§å„ç¨®ã‚³ãƒãƒ³ãƒ‰ã‚’ã¾ã¨ã‚ã‚‹

```bash:Makefile
NAME := gotail
NAME-C := gotailcheck

.PHONY: all
all: docker-build docker-run

.PHONY: docker-build
docker-build:
	docker build -t $(NAME) .

.PHONY: docker-run
docker-run:
	docker run -t $(NAME)

check: docker-build docker-run-covercheck open clean

docker-run-covercheck:
	docker run --rm --name $(NAME-C) -itd $(NAME) /bin/sh
	docker cp $(NAME-C):/root/convert.html $(shell pwd)
	docker stop $(NAME-C)
	cp convert.html $(shell pwd)/coverchecklog/$(shell date +"%Y%m%d%I%M%S").html

.PHONY: open
open:
	open convert.html

.PHONY: clean
clean:
	sleep 10
	rm -f cover.out convert.html
```

ã“ã®ã‚ˆã†ã«è¨˜è¿°ã—ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã¨`/coverchecklog`ã«ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã§ãã‚‹htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã€è‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ç«‹ã¡ä¸Šã’ã¦ç¢ºèªã§ãã¾ã™ã€‚

```bash
make check
```

```bash
docker-run-covercheck:
	docker run --rm --name $(NAME-C) -itd $(NAME) /bin/sh
	docker cp $(NAME-C):/root/convert.html $(shell pwd)
	docker stop $(NAME-C)
	cp convert.html $(shell pwd)/coverchecklog/$(shell date +"%Y%m%d%I%M%S").html
```

`docker run --rm`ã§dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‡¦ç†ãŒçµ‚ã‚ã£ãŸå¾Œã«è‡ªå‹•ã§å‰Šé™¤ã—ã¦ãã‚Œã¾ã™ã€‚

ã¾ãŸã€`--name`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€IDã§ã¯ãªãã¦nameã§`docker cp`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

dockerã®`cp`ãŒçµ‚ã‚ã£ãŸã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åœæ­¢ã—ã¾ã™ã€‚

æœ€å¾Œã«ç¾åœ¨ã®æ™‚é–“ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦ã€`coverchecklog`ã«ã‚³ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸhtmlã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

```bash
cp convert.html $(shell pwd)/coverchecklog/$(shell date +"%Y%m%d%I%M%S").html
```

å…¨ã¦ã®è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¬æ™‚ã«ç¢ºèªã§ãã€è¨˜éŒ²ã‚‚æ®‹ã—ã¦ãã‚Œã¾ã™ã€‚

```bash
make check
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ„è­˜ã—ãŸé–‹ç™ºã‚’æ‰‹è»½ã«è¡Œã†ã“ã¨ãŒã§ããã†ã§ã™ã€‚

# æœ€å¾Œã«

ä»Šå›ã¯docker cpã®ä½¿ã„æ–¹ã«è©°ã¾ã£ã¦ãŠã‚Šã¾ã—ãŸã€dockerã‚³ãƒãƒ³ãƒ‰ã¯çµæ§‹è¦šãˆã‚‹ã“ã¨ãŒå¤šã„ã®ã§ãŸã¾ã«æ··ä¹±ã—ã¦ã—ã¾ã†ã®ã§ã™ãŒã€Makefileã«ã¾ã¨ã‚ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚
ã¾ã ã¾ã golangã¯å§‹ã‚ãŸã°ã‹ã‚Šã§åˆ†ã‹ã‚‰ãªã„ã“ã¨ã°ã‹ã‚Šã§ã™ãŒã€golangã«ãŠã‘ã‚‹Makefileã®è¨˜è¿°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è¿½æ±‚ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

