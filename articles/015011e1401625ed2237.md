---
title: "Golang + Docker + RDB ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ›ã‚¹ãƒˆåã®å•é¡Œ"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Golang","Docker","RDB","testing"]
published: true
---

# Golang + Docker + RDB ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ›ã‚¹ãƒˆåã®å•é¡Œ

æœ€è¿‘ Golang ãŒæ¥½ã—ããªã£ã¦ããŸã€ä»Šå›ã¯ã€Golang + Docker + RDB ã§ Golangã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ RDB ç­‰ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ãŸã„ã¨ãã«ã€å®Ÿè¡Œæ™‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ›ã‚¹ãƒˆåã‚’èª­ã¿ã‹ãˆãªã‘ã‚Œã°ãªã‚‰ãªã„å•é¡Œã«é–¢ã—ã¦ã€è‡ªå‹•åŒ–ã‚’å›³ã‚‹æ–¹æ³•ãŒã‚ã£ãŸã®ã§ã€ãã®ãƒ¡ãƒ¢ã€‚

# ä½•ãŒã—ãŸã„ã®ã‹
Golang ã® test ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ config.ReadConfig() ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§è¨­å®šã®èª­ã¿ã‹ãˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
Docker ç­‰ã‚’æ´»ç”¨ã—ã¦ã„ã‚‹éš›ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¨ä»®æƒ³ç’°å¢ƒå†…ã§æ¥ç¶šå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„ã¨ãã«ä½¿ç”¨ã—ã¾ã™ã€‚

# å„ç¨®ã‚¹ãƒ†ãƒƒãƒ—

æ›¸ãæ›ãˆãŸã„ãƒ•ã‚¡ã‚¤ãƒ«

```yaml:config.yml
db:
  host: host.docker.internal #ã“ã“ã‚’localhostã«æ›¸ãæ›ãˆãŸã„
  name: title
  password: password
  user: user
```

ä»Šã¾ã§ã¯æ‰‹å‹•ã§ã„ã¡ã„ã¡åˆ‡ã‚Šæ›¿ãˆã¦ã„ãŸãŒã€ã‚ã¾ã‚Šã«ã‚‚åŠ¹ç‡ãŒæ‚ªã™ãã‚‹ã®ã§ã€test ã‚’èµ°ã‚‰ã›ã‚‹éš›ã«ã€è‡ªå‹•ã§æ›¸ãæ›ãˆã‚’è¡Œã„ãŸã„ã€‚

ã¾ãšã€`config.go`

```go:config.go
package config

import (
	"io/ioutil"
	"os"

	err "path/to/pkg/error"

	yaml "gopkg.in/yaml.v2"
)

type Config struct {
	DB configDB `yaml:"db"`
}

type configDB struct {
	Host     string `yaml:"host"`
	Name     string `yaml:"name"`
	Password string `yaml:"password"`
	User     string `yaml:"user"`
}

func ReadConfig() (*Config, error) {
	file := os.Getenv("CONFIG")
	if file == "" {
		return nil, err.ErrorEmptyEnvironmentVariableConfig
	}

	buf, err := ioutil.ReadFile(file)
	if err != nil {
		return nil, err
	}

	var config Config
	err = yaml.Unmarshal([]byte(buf), &config)
	if err != nil {
		return nil, err
	}

	return &config, nil
}

```

Golangã«ã¯YAMLã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ã®ã§ã€
ãªã®ã§å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã‚’ä½¿ã£ã¦ã€
Golangã®æ§‹é€ ä½“ã‚„ãƒãƒƒãƒ—ãªã©ã«å¤‰æ›(Unmarshal) ã¨ã€Golangã®ãƒ‡ãƒ¼ã‚¿å‹ã‹ã‚‰YAMLã«å¤‰æ›(Marshal)ã§ãã‚‹ã€‚

```
ãƒ©ã‚¤ãƒ–ãƒ©ãƒª yaml.v2

ã‚½ãƒ¼ã‚¹: go-yaml/yaml GitHub
```

æ§‹é€ ä½“ã«configã®é …ç›®ã‚’å®šç¾©ã—ã€èª­ã¿ã‹ãˆã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

```go
type configDB struct {
	Host     string `yaml:"host"`
	Name     string `yaml:"name"`
	Password string `yaml:"password"`
	User     string `yaml:"user"`
}
```

æ¬¡ã«ä¾‹ãˆã°`setup_test.go`ã‚’æ›¸ã

```go
package db_test

import (
        "path/to/pkg/config"
	db "path/to/pkg/db"
	"os"
	"testing"
)

func TestMigration(t *testing.T) {
	os.Setenv("CONFIG", "../../config.yml")
	config, _ := config.ReadConfig()
	config.DB.Host = "localhost" #ã“ã“ã§èª­ã¿ã‹ãˆã¾ã™

	db.ConnectDatabase(config)
}
```

errorãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```go:error.go
package error

import (
	"golang.org/x/xerrors"
)

var (
	ErrorEmptyEnvironmentVariableConfig = xerrors.New("Environment variable CONFIG is empty.")
)
```

ã“ã®ã‚ˆã†ã«testã‚³ãƒ¼ãƒ‰ã‹ã‚‰config.ReadConfig()ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§èª­ã¿ã‹ãˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

Docker ç­‰ã‚’æ´»ç”¨ã—ã¦ã„ã‚‹éš›ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¨ä»®æƒ³ç’°å¢ƒå†…ã§æ¥ç¶šå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„ã¨ããŒåº¦ã€…ç™ºç”Ÿã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€æœ¬å½“ã«ä¾¿åˆ©ã§ã™ã­ã€‚

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€
ã‚‚ã£ã¨ã‚¹ãƒãƒ¼ãƒˆãªæ–¹æ³•ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‚ˆã¨ã„ã†æ–¹ãŒãŠã‚‰ã‚Œã¾ã—ãŸã‚‰ãœã²ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„!


