---
title: "Goè¨€èªã§tailã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã£ã¦ã¿ã‚‹"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go","tail","GitHubActions","CI"]
published: true
---

# Goè¨€èªã§tailã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã£ã¦ã¿ã‚‹

æœ€è¿‘Goè¨€èªã‚’å‹‰å¼·ã—å§‹ã‚ãŸãŒã€ãã®å‹‰å¼·ã®ä¸€ç’°ã§tailã‚³ãƒãƒ³ãƒ‰ã‚’Goè¨€èªã§ä½œã£ã¦ã¿ã‚‹ã€‚
å®Ÿè£…ã‹ã‚‰ã€testingã‚’ç”¨ã„ãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€GitHub Actionsã‚’ä½¿ã£ãŸCI/CDã¾ã§ã‚’ã‚„ã£ã¦ã¿ãŸã„ã¨æ€ã†ã€‚

:::message
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãªã©ã«ã‚ˆã‚Šã€æ‰‹é †ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„
:::

# æµã‚Œ

+ Dockerã«ã‚ˆã‚‹Goã®é–‹ç™ºç’°å¢ƒæ§‹ç¯‰
+ ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®å®Ÿç¾
+ å¤§ã¾ã‹ãªä»•æ§˜ã‚’è€ƒãˆã¦ã¿ã‚‹
+ å®Ÿè£…
+ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
+ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
+ GitHub Actionsã«ã‚ˆã‚‹CI/CD(Go,Docker)

# é–‹ç™ºç’°å¢ƒ

+ macOS BigSur 11.2.3ï¼ˆ20D91ï¼‰
+ Docker Desktop for Mac 20.10.5, build 55c4c88

# Dockerã«ã‚ˆã‚‹Goã®é–‹ç™ºç’°å¢ƒæ§‹ç¯‰

ã¾ãšã€ä»Šã¾ã§Goã‚’ä½¿ã£ãŸã“ã¨ãŒãªã„ã®ã§ã€ä»Šå¾Œã®ã“ã¨ã‚‚è€ƒãˆã¦ã€Dockerã«ã‚ˆã‚‹Goã®é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã„ã€‚

### Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

![](https://storage.googleapis.com/zenn-user-upload/nmifmqq7v5vkubr3imytadieiq08)

Docker for Macã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰Dockerã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã€DockerHubã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
https://hub.docker.com/editions/community/docker-ce-desktop-mac

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾ŒCLIã§ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```bash
$ docker -v
Docker version 20.10.5, build 55c4c88
```

ã“ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰å®Œäº†ã€‚

è©¦ã—ã«ubuntuã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚
ã¾ãšã€testãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ç­‰ã‚’ä½œã£ã¦Dockerfileã‚’ä½œæˆã™ã‚‹ã€‚

```bash
$ mkdir test
$ cd test
$ echo "From ubuntu" > Dockerfile
```

æ¬¡ã«ãƒ“ãƒ«ãƒ‰ã—ã¦ã€shellã«å…¥ã£ã¦ã¿ã¾ã™ã€‚

```bash
$ docker build -t test .
$ docker run -it test bash
$ cat /etc/os-release
```

ç„¡äº‹ã«èµ·å‹•ã§ãã‚Œã°ã“ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

```
NAME="Ubuntu"
VERSION="20.04.2 LTS (Focal Fossa)"
```
ã“ã‚Œã§Dockerã®å‹•ä½œã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ä¸è¦ãªã®ã§ä¸€æ—¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å«ã‚ã¦å‰Šé™¤ã—ã¾ã—ã‚‡ã†ã€‚

```
$ docker system prune -a
```

# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®å®Ÿç¾

åå‰ã ã‘èãã¨é›£ã—ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ãŒã€ç°¡å˜ã«ã¾ã¨ã‚ã‚‹ã¨

+ æœ¬æ¥è¤‡æ•°ã®DockerfileãŒå¿…è¦ãªå ´åˆã«å¯¾ã—ã¦ã€ä¸€ã¤ã®Dockerfileã‹ã‚‰è¤‡æ•°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸BuildãŒã§ãã‚‹
+ Fromã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ä½œç”¨ã•ã›ã€è¤‡æ•°ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç”Ÿæˆç‰©ã‚’ç¶™æ‰¿ã§ãã‚‹ã¨ã„ã†ã“ã¨

ã¨ã„ã†ã“ã¨ã§ã™ã€ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ã€è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€ã¤ã®Dockerfileã§ç®¡ç†ã§ãã‚‹ã“ã¨ã§ã™ã€‚

ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®è¨­å®šã®å‰ã«ã€ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’æ±ºã‚ã¾ã—ã‚‡ã†ã€‚


```bash:local
 gotail
 â”œâ”€â”€ .github
 â”‚    â””â”€â”€ workflows
 â”‚        â””â”€â”€ go.yml
 â”œâ”€â”€ README.md
 â”œâ”€â”€ Dockerfile
 â”œâ”€â”€ Makefile
 â”œâ”€â”€ main.go
 â”œâ”€â”€ main_test.go
 â”œâ”€â”€ test.txt
 â”œâ”€â”€ cmd.sh
 â””â”€â”€ covercheck.sh
```

æ¬¡ã«ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«ãŠã‘ã‚‹ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’è€ƒãˆã¦ã¿ã‚‹ã€‚

### ã‚³ãƒ³ãƒ†ãƒŠ1:go

```bash:stage1
 go
 â””â”€â”€ src
     â”œâ”€â”€ main.go
     â”œâ”€â”€ main_test.go
     â”œâ”€â”€ test.txt
     â””â”€â”€ cmd.sh
```

### ã‚³ãƒ³ãƒ†ãƒŠ2:alpine linux
```bash:stage2
 root
 â”œâ”€â”€ main
 â”œâ”€â”€ test.txt
 â””â”€â”€ cmd.sh
```

ä¸Šè¨˜ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```docker:/local/Dockerfile
FROM golang:latest
WORKDIR /go/src
COPY main.go .
COPY main_test.go .
COPY test.txt .
COPY cmd.sh .
RUN go test main_test.go main.go -v
RUN go build main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates && \
    apk add bash
WORKDIR /root
COPY --from=0 /go/src/main .
COPY --from=0 /go/src/test.txt .
COPY --from=0 /go/src/cmd.sh .
CMD ["./cmd.sh"]
```

ä»¥ä¸Šã§ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¯å®Œäº†ã§ã™ã€‚

è©³ã—ãã¯å…¬å¼ã‚µã‚¤ãƒˆã‚’ã¿ã¦ãã ã•ã„ã€‚
https://docs.docker.com/develop/develop-images/multistage-build/

# å¤§ã¾ã‹ãªä»•æ§˜ã‚’æ±ºã‚ã‚‹

ä»Šå›ã¯tailã‚³ãƒãƒ³ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã¨ã€-nã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã¨æ€ã†ã€‚

### tailã¨ã¯
ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚è¡Œã‹ã‚‰æ•°è¡Œã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã€ æ¨™æº–ã§ã¯ï¼‘ï¼è¡Œã‚’è¡¨ç¤ºã™ã‚‹ã€‚

```
tail 
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -n
å‡ºåŠ›ã™ã‚‹è¡Œæ•°ã‚’æŒ‡å®šã™ã‚‹
```

ã¾ãŸã€-nã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€FIFOã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ã£ã¦å®Ÿè£…ã™ã‚‹ã€‚

## FIFOã¨ã¯

FIFOã¨ã¯ã€First In First Outã®ç•¥ç§°ã§ã™ã€‚
FIFOã‚’ç”¨ã„ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«æ ¼ç´ã™ã‚‹ã“ã¨ãªããƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

Wikiã«è©³ã—ãè¼‰ã£ã¦ã„ã¾ã™ã€‚
https://ja.wikipedia.org/wiki/FIFO

ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ã£ã¦tailã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã‚³ãƒãƒ³ãƒ‰æœ¬ä½“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§
```go:main.go
import (
	"bufio"
	"flag"
	"fmt"
	"math"
	"os"
)
```

testã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§
```go:main_test.go
import (
	"bufio"
	"fmt"
	"os"
	"reflect"
	"strconv"
	"testing"
)
```

ã¾ãšã€åˆã‚ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã‚ˆã†ã«ç´°ã‹ãå®Ÿè£…ã—ã¾ã™ã€‚

ã‚­ãƒ¥ãƒ¼ã®åˆæœŸåŒ–
```go:init_queue
func init_queue() ([]string, int) {
	queue := []string{}
	cursor := 0
	return queue, cursor
}
```

ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼
```go:enqueue
func enqueue(queue []string, value string) []string {
	queue = append(queue, value)
	return queue
}
```

ãƒ‡ã‚­ãƒ¥ãƒ¼
```go:dequeue
func dequeue(queue []string) []string {
	queue = queue[1:]
	return queue
}
```

ã‚­ãƒ¥ãƒ¼ã®å–ã‚Šå‡ºã—
```go:show_queue
func show_queue(queue []string, n int) []string {
	if len(queue) == n {
		for i := n; i > 0; i-- {
			if len(queue) != 0 {
				fmt.Println(queue[0])
			}
			queue = dequeue(queue)
		}
	} else {
		for i := len(queue); i > 0; i-- {
			if len(queue) != 0 {
				fmt.Println(queue[0])
			}
			queue = dequeue(queue)
		}
	}
	return queue
}
```

ä¸€é€£ã®æµã‚Œã‚’tailã¨ã—ã¦å®šç¾©
```go:tail
func tail(stream *os.File, err error, n int) []string {
	queue, cursor := init_queue()
	scanner := bufio.NewScanner(stream)
	for scanner.Scan() {
		if n < 1 {
			n = int(math.Abs(float64(n)))
			if n == 0 {
				n = 10
			}
		}
		queue = enqueue(queue, scanner.Text())
		if n-1 < cursor {
			queue = dequeue(queue)
		}
		cursor++
	}
	return queue
}
```

å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚â€»ã“ã“ã§ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«queueã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
`test.txt`ã«ã¯1~100ã®é€£ç•ªãŒä¸€è¡Œãšã¤å…¥ã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```bash:bash
for i in `seq 100` do
for> echo $i >> test.txt
```

```go:main.go
$ go run main.go test.txt
[1]
[1 2]
[1 2 3]
[1 2 3 4]
[1 2 3 4 5]
[1 2 3 4 5 6]
[1 2 3 4 5 6 7]
[1 2 3 4 5 6 7 8]
[1 2 3 4 5 6 7 8 9]
[1 2 3 4 5 6 7 8 9 10]
[1 2 3 4 5 6 7 8 9 10 11]
[2 3 4 5 6 7 8 9 10 11 12]
[3 4 5 6 7 8 9 10 11 12 13]
[4 5 6 7 8 9 10 11 12 13 14]
[5 6 7 8 9 10 11 12 13 14 15]
[6 7 8 9 10 11 12 13 14 15 16]
[7 8 9 10 11 12 13 14 15 16 17]
[8 9 10 11 12 13 14 15 16 17 18]
[9 10 11 12 13 14 15 16 17 18 19]
[10 11 12 13 14 15 16 17 18 19 20]
[11 12 13 14 15 16 17 18 19 20 21]
[12 13 14 15 16 17 18 19 20 21 22]
[13 14 15 16 17 18 19 20 21 22 23]
[14 15 16 17 18 19 20 21 22 23 24]
[15 16 17 18 19 20 21 22 23 24 25]
[16 17 18 19 20 21 22 23 24 25 26]
[17 18 19 20 21 22 23 24 25 26 27]
[18 19 20 21 22 23 24 25 26 27 28]
[19 20 21 22 23 24 25 26 27 28 29]
[20 21 22 23 24 25 26 27 28 29 30]
[21 22 23 24 25 26 27 28 29 30 31]
[22 23 24 25 26 27 28 29 30 31 32]
[23 24 25 26 27 28 29 30 31 32 33]
[24 25 26 27 28 29 30 31 32 33 34]
[25 26 27 28 29 30 31 32 33 34 35]
[26 27 28 29 30 31 32 33 34 35 36]
[27 28 29 30 31 32 33 34 35 36 37]
[28 29 30 31 32 33 34 35 36 37 38]
[29 30 31 32 33 34 35 36 37 38 39]
[30 31 32 33 34 35 36 37 38 39 40]
[31 32 33 34 35 36 37 38 39 40 41]
[32 33 34 35 36 37 38 39 40 41 42]
[33 34 35 36 37 38 39 40 41 42 43]
[34 35 36 37 38 39 40 41 42 43 44]
[35 36 37 38 39 40 41 42 43 44 45]
[36 37 38 39 40 41 42 43 44 45 46]
[37 38 39 40 41 42 43 44 45 46 47]
[38 39 40 41 42 43 44 45 46 47 48]
[39 40 41 42 43 44 45 46 47 48 49]
[40 41 42 43 44 45 46 47 48 49 50]
[41 42 43 44 45 46 47 48 49 50 51]
[42 43 44 45 46 47 48 49 50 51 52]
[43 44 45 46 47 48 49 50 51 52 53]
[44 45 46 47 48 49 50 51 52 53 54]
[45 46 47 48 49 50 51 52 53 54 55]
[46 47 48 49 50 51 52 53 54 55 56]
[47 48 49 50 51 52 53 54 55 56 57]
[48 49 50 51 52 53 54 55 56 57 58]
[49 50 51 52 53 54 55 56 57 58 59]
[50 51 52 53 54 55 56 57 58 59 60]
[51 52 53 54 55 56 57 58 59 60 61]
[52 53 54 55 56 57 58 59 60 61 62]
[53 54 55 56 57 58 59 60 61 62 63]
[54 55 56 57 58 59 60 61 62 63 64]
[55 56 57 58 59 60 61 62 63 64 65]
[56 57 58 59 60 61 62 63 64 65 66]
[57 58 59 60 61 62 63 64 65 66 67]
[58 59 60 61 62 63 64 65 66 67 68]
[59 60 61 62 63 64 65 66 67 68 69]
[60 61 62 63 64 65 66 67 68 69 70]
[61 62 63 64 65 66 67 68 69 70 71]
[62 63 64 65 66 67 68 69 70 71 72]
[63 64 65 66 67 68 69 70 71 72 73]
[64 65 66 67 68 69 70 71 72 73 74]
[65 66 67 68 69 70 71 72 73 74 75]
[66 67 68 69 70 71 72 73 74 75 76]
[67 68 69 70 71 72 73 74 75 76 77]
[68 69 70 71 72 73 74 75 76 77 78]
[69 70 71 72 73 74 75 76 77 78 79]
[70 71 72 73 74 75 76 77 78 79 80]
[71 72 73 74 75 76 77 78 79 80 81]
[72 73 74 75 76 77 78 79 80 81 82]
[73 74 75 76 77 78 79 80 81 82 83]
[74 75 76 77 78 79 80 81 82 83 84]
[75 76 77 78 79 80 81 82 83 84 85]
[76 77 78 79 80 81 82 83 84 85 86]
[77 78 79 80 81 82 83 84 85 86 87]
[78 79 80 81 82 83 84 85 86 87 88]
[79 80 81 82 83 84 85 86 87 88 89]
[80 81 82 83 84 85 86 87 88 89 90]
[81 82 83 84 85 86 87 88 89 90 91]
[82 83 84 85 86 87 88 89 90 91 92]
[83 84 85 86 87 88 89 90 91 92 93]
[84 85 86 87 88 89 90 91 92 93 94]
[85 86 87 88 89 90 91 92 93 94 95]
[86 87 88 89 90 91 92 93 94 95 96]
[87 88 89 90 91 92 93 94 95 96 97]
[88 89 90 91 92 93 94 95 96 97 98]
[89 90 91 92 93 94 95 96 97 98 99]
[90 91 92 93 94 95 96 97 98 99 100]
91
92
93
94
95
96
97
98
99
100
```

æ¬¡ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã§ããŸã‚‰ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†
é–¢æ•°ã‚’ã§ãã‚‹ã ã‘ã¾ã¨ã‚ã¦ã¿ã‚‹ã€‚

```go:tail
func tail(stream *os.File, n int) []string {
	queue := []string{}
	scanner := bufio.NewScanner(stream)
	for scanner.Scan() {
		queue = append(queue, scanner.Text())
		if n <= len(queue)-1 {
			queue = queue[1:]
		}
	}
	return queue
}

func show(queues []string) {
	for _, queue := range queues {
		fmt.Println(queue)
	}
}
```

## å¼•æ•°ã€flagã‚’è¨­å®šã™ã‚‹

mainã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã ã‚Šã€æ¨™æº–å…¥åŠ›ã‚’èª­ã‚€å‡¦ç†ã‚„ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚
è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãã®å‡¦ç†ã‚‚æ›¸ãã¾ã™ã€‚

```go:main
func main() {
	const USAGE string = "Usage: gotail [-n #] [file]"
	intOpt := flag.Int("n", 10, USAGE)
	flag.Usage = func() {
		fmt.Println(USAGE)
	}
	flag.Parse()
	n := int(math.Abs(float64(*intOpt)))
	if flag.NArg() > 0 {
		for i := 0; i < flag.NArg(); i++ {
			if i > 0 {
				fmt.Print("\n")
			}
			if flag.NArg() != 1 {
				fmt.Println("==> " + flag.Arg(i) + " <==")
			}
			fp, err := os.Open(flag.Arg(i))
			if err != nil {
				fmt.Println("Error: No such file or directory")
				os.Exit(1)
			}
			defer fp.Close()
			show(tail(fp, n))
		}
	} else {
		show(tail(os.Stdin, n))
	}
}
```

# ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
æ¬¡ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã€‚
ã“ã“ã§ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ã¦ã„ã‚‹`test.txt`ã‚’èª­ã¿è¾¼ã‚“ã§æ¤œè¨¼ã™ã‚‹ã€‚
ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦è€ƒãˆã†ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸€é€šã‚Šè©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚
ä»Šå›ã¯`test.txt`ã¯100è¡Œã®é€£ç•ªæ•°å­—ã®ãƒ‡ãƒ¼ã‚¿ã§ã€`-n 1 ~ -n 100`ã¾ã§é †ã«ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã€‚

```go:testTail
func TestTail(t *testing.T) {
	var actual_all []string
	var expected_all []string
	count := 0
	fp, err := os.Open("./test.txt")
	if err != nil {
		fmt.Println("Error: No such file or directory")
		os.Exit(1)
	}
	defer fp.Close()
	scanner := bufio.NewScanner(fp)
	for scanner.Scan() {
		count++
	}
	n_all := 1
	for i := count; i > 0; i-- {
		fp, err = os.Open("./test.txt")
		actual_all = tail(fp, n_all)
		expected_all = append([]string{strconv.Itoa(i)}, expected_all...)
		if reflect.DeepEqual(actual_all, expected_all) {
			t.Log(reflect.DeepEqual(actual_all, expected_all))
		} else {
			t.Errorf("got %v\nwant %v", actual_all, expected_all)
		}
		n_all++
	}
}
```

# ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
ã¾ãŸã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã™ã‚‹ã€‚
æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€
`$ ulimit -a`ã§ç¢ºèªã™ã‚‹ã€‚å¿…è¦ã«å¿œã˜ã¦`$ ulimit -n 500`ç­‰ã‚’å®Ÿè¡Œã—ã‚ˆã†ã€‚

```go:testcover
$ go test main_test.go main.go -coverprofile=cover.out
$ go tool cover -html=cover.out -o cover.html
$ open cover.html
```

ã“ã®ã‚ˆã†ãªå½¢ã§ç¢ºèªã§ãã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/i304n67xlsoyvxcgoad67imia3hm)

ã ã„ãŸã„8å‰²ã‚’è¶…ãˆã¦ã„ã‚‹ã®ã§æ¬¡ã«é€²ã‚€ã€‚

dockerã‚’ç«‹ã¡ä¸Šã’ã¦buildã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚
å…ˆç¨‹ã®Dockerfileã®è¨­å®šã«ã‚ˆã£ã¦ã€testã®å®Ÿæ–½ã‚‚è¡Œã†ã€‚
cmd.shã«ã€stage2ã§å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã‚ˆã†ã€‚

```bash:cmd.sh
#!/bin/sh -eux
./main < test.txt
```

è¨˜è¿°ã§ããŸã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚’ã„ã¡ã„ã¡æ‰“ã¤ã®ã¯é¢å€’ãªã®ã§ã€Makefileã§ã‚³ãƒãƒ³ãƒ‰ã‚’å˜ç´”åŒ–ã™ã‚‹ã€‚

```bash:Makefile
NAME := gotail

.PHONY: all
all: docker-build docker-run

.PHONY: docker-build
docker-build:
	docker build -t $(NAME) .

.PHONY: docker-run
docker-run:
	docker run --rm $(NAME)
```

```bash
$ make
```

ã“ã‚Œã§ã€ä¸€é€£ã®å®Ÿè¡ŒãŒç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚

# GitHub Actionsã«ã‚ˆã‚‹CI/CD(Go,Docker)

GitHub Actionsã§ã¯GitHubä¸Šã§testã‚’èµ°ã‚‰ã›ãŸã‚Šã€buildã‚’ã—ãŸã‚Šã§ãã‚‹ã®ã§å¤§å¤‰ä¾¿åˆ©ã§ã™ã€‚
ä»Šå›ã¯goå˜ä½“ã§æ¤œè¨¼ã™ã‚‹Actionã¨Dockerã‚’èµ·å‹•ã™ã‚‹Actionã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚

ã¾ãšã€æ¬¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

```
 gotail
 â””â”€.github
    â””â”€â”€ workflows
        â””â”€â”€ go.yml
```

Actionã®è¨­å®šã¯YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§è¨˜è¿°ã™ã‚‹ã€‚
ã¾ãšã¯ã€go.ymlã‚’è¨˜è¿°ã—ã‚ˆã†ã€‚

```yaml:go.yml
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15

    - name: Build
      run: go build -v ./main.go

    - name: Test
      run: go test -v ./main_test.go main.go
```

å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒä¸Šã¸pushã¨pullrequestã‚’è¡Œã£ãŸéš›ã«ã€ActionãŒèµ°ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹ã€‚
ã¾ãŸã€buildã¨testã‚’å®Ÿè¡Œã§ãã‚‹ã€‚

æ¬¡ã«dockerã®èµ·å‹•ã‚‚è©¦ã—ã¦ã¿ã‚‹ã€‚

```
 gotail
 â””â”€.github
    â””â”€â”€ workflows
        â””â”€â”€ docker.yml
```

```yaml:docker.yml
name: CI to Docker Hub
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Check Out Repo
              uses: actions/checkout@v2
            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v1
            - name: Build and push
              id: docker_build
              uses: docker/build-push-action@v2
              with:
                    context: ./
                    file: ./Dockerfile
                    push: true
                    tags: ${{ secrets.DOCKER_HUB_USERNAME }}/simplewhale:latest
            - name: Image digest
              run: echo ${{ steps.docker_build.outputs.digest }}

            - name: Run
              run: make
```

ã“ã®secretsã¯Githubã‚„Dockerhubä¸Šã§ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚
ã¾ãšã€Docker Hubã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

https://hub.docker.com/

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒã§ããŸã‚‰ã€æ¬¡ã«å³ä¸Šã«ã‚ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã€ä»¥ä¸‹ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/qjssrgpbrr8fxcyi4eliuhyt1sr9)

æ¬¡ã«ã€Securityâ†’New Access Tokenã®é †ã«ã‚¯ãƒªãƒƒã‚¯ã€‚

![](https://storage.googleapis.com/zenn-user-upload/nso8p6lzjcn83l1rk9y65hhr6kpx)

TokenãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€é©å½“ã«titleãªã©ã‚’å…¥åŠ›ã—ã€Copyã—ã¦ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4fyfvf8oohf87br3s9vmcthkn9vr)

æ¬¡ã«Githubã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

https://github.com/

Settingâ†’Secretâ†’New repository secretã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã‚Œãã‚Œå…ˆç¨‹ã®Tokenã‚„Docker Hubã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®šã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/yxvr3kk28w5nngzjpsnq6f2idfsc)
![](https://storage.googleapis.com/zenn-user-upload/5cyavidzcj7xagc3zwe5zaaetr13)
![](https://storage.googleapis.com/zenn-user-upload/214pnbq0ffx12tyymyn9jcmal0aw)

ä»¥ä¸Šã§è¨­å®šã¯å®Œäº†ã§ã™ã€‚
æœ€å¾Œã«ãƒªãƒã‚¸ãƒˆãƒªã«pushã‹pullrequestã‚’è¡Œã†ã¨è‡ªå‹•ã§ActionãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ç­‰ã¯ã€ã“ã®è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã‚‹æ®µéšã§ã¯ã€ã¾ã masterã«ãƒãƒ¼ã‚¸ã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€Githubã«ã‚‚ã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã®ã§ã€å‚è€ƒã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ãƒªãƒ³ã‚¯è²¼ã£ã¦ãŠãã¾ã™ã€‚
https://github.com/Iovesophy/gotail

# ã¾ã¨ã‚
ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
Goè¨€èªã¯åˆã‚ã¦ã§ã—ãŸãŒã€Goè¨€èªã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã‚ˆãæŒ™ã’ã‚‰ã‚Œã‚‹ã€åˆå¿ƒè€…ã§ã‚‚ç†è§£ã—ã‚„ã™ã„ã€å‡¦ç†ã®é€Ÿåº¦ãŒé€Ÿã„ã€å°‘ãªã„ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã§ãã‚‹ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè±Šå¯Œã€ä¸¦è¡Œå‡¦ç†ãŒå¯èƒ½ã€å®‰å…¨æ€§ãŒé«˜ã„ã¨ã„ã†ã®ã¯ã¾ã•ã«ãã®é€šã‚Šã§ã‚ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
æ¬¡ã¯ç°¡å˜ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ä½œã‚„ä¸¦è¡Œå‡¦ç†ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
