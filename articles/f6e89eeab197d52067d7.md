---
title: "GoË®ÄË™û„Åßtail„Ç≥„Éû„É≥„Éâ„Çí‰Ωú„Å£„Å¶„Åø„Çã"
emoji: "ü§ñ"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["go","tail","GitHubActions","CI"]
published: true
---

# GoË®ÄË™û„Åßtail„Ç≥„Éû„É≥„Éâ„Çí‰Ωú„Å£„Å¶„Åø„Çã

ÊúÄËøëGoË®ÄË™û„ÇíÂãâÂº∑„ÅóÂßã„ÇÅ„Åü„Åå„ÄÅ„Åù„ÅÆÂãâÂº∑„ÅÆ‰∏ÄÁí∞„Åßtail„Ç≥„Éû„É≥„Éâ„ÇíGoË®ÄË™û„Åß‰Ωú„Å£„Å¶„Åø„Çã„ÄÇ
ÂÆüË£Ö„Åã„Çâ„ÄÅtesting„ÇíÁî®„ÅÑ„Åü„É¶„Éã„ÉÉ„Éà„ÉÜ„Çπ„Éà„ÄÅGitHub Actions„Çí‰Ωø„Å£„ÅüCI/CD„Åæ„Åß„Çí„ÇÑ„Å£„Å¶„Åø„Åü„ÅÑ„Å®ÊÄù„ÅÜ„ÄÇ

:::message
„Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„Éó„Å™„Å©„Å´„Çà„Çä„ÄÅÊâãÈ†Ü„ÅåÁï∞„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„ÅßÊ≥®ÊÑè„Åó„Å¶„Åè„Å†„Åï„ÅÑ
:::

# ÊµÅ„Çå

+ Docker„Å´„Çà„ÇãGo„ÅÆÈñãÁô∫Áí∞Â¢ÉÊßãÁØâ
+ „Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„ÅÆÂÆüÁèæ
+ Â§ß„Åæ„Åã„Å™‰ªïÊßò„ÇíËÄÉ„Åà„Å¶„Åø„Çã
+ ÂÆüË£Ö
+ „É¶„Éã„ÉÉ„Éà„ÉÜ„Çπ„Éà
+ „ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆÁ¢∫Ë™ç
+ GitHub Actions„Å´„Çà„ÇãCI/CD(Go,Docker)

# ÈñãÁô∫Áí∞Â¢É

+ macOS BigSur 11.2.3Ôºà20D91Ôºâ
+ Docker Desktop for Mac 20.10.5, build 55c4c88

# Docker„Å´„Çà„ÇãGo„ÅÆÈñãÁô∫Áí∞Â¢ÉÊßãÁØâ

„Åæ„Åö„ÄÅ‰ªä„Åæ„ÅßGo„Çí‰Ωø„Å£„Åü„Åì„Å®„Åå„Å™„ÅÑ„ÅÆ„Åß„ÄÅ‰ªäÂæå„ÅÆ„Åì„Å®„ÇÇËÄÉ„Åà„Å¶„ÄÅDocker„Å´„Çà„ÇãGo„ÅÆÈñãÁô∫Áí∞Â¢É„ÇíÊßãÁØâ„Åó„Åü„ÅÑ„ÄÇ

### Docker„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´

![](https://storage.googleapis.com/zenn-user-upload/nmifmqq7v5vkubr3imytadieiq08)

Docker for Mac„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
ÂÖ¨Âºè„Çµ„Ç§„Éà„Åã„ÇâDocker„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰Ωú„Å£„Å¶„É≠„Ç∞„Ç§„É≥„Åó„ÄÅDockerHub„Åã„Çâ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´„Åô„Çã„ÄÇ
https://hub.docker.com/editions/community/docker-ce-desktop-mac

„Ç§„É≥„Çπ„Éà„Éº„É´ÂæåCLI„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åø„Çã„ÄÇ

```bash
$ docker -v
Docker version 20.10.5, build 55c4c88
```

„Åì„ÅÆ„Çà„ÅÜ„Å´„Éê„Éº„Ç∏„Éß„É≥„ÅåË°®Á§∫„Åï„Çå„Åü„ÇâÂÆå‰∫Ü„ÄÇ

Ë©¶„Åó„Å´ubuntu„Çí‰Ωø„Å£„Å¶„Åø„Çã„ÄÇ
„Åæ„Åö„ÄÅtest„Éï„Ç©„É´„ÉÄ„ÉºÁ≠â„Çí‰Ωú„Å£„Å¶Dockerfile„Çí‰ΩúÊàê„Åô„Çã„ÄÇ

```bash
$ mkdir test
$ cd test
$ echo "From ubuntu" > Dockerfile
```

Ê¨°„Å´„Éì„É´„Éâ„Åó„Å¶„ÄÅshell„Å´ÂÖ•„Å£„Å¶„Åø„Åæ„Åô„ÄÇ

```bash
$ docker build -t test .
$ docker run -it test bash
$ cat /etc/os-release
```

ÁÑ°‰∫ã„Å´Ëµ∑Âãï„Åß„Åç„Çå„Å∞„Åì„ÅÆ„Çà„ÅÜ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ

```
NAME="Ubuntu"
VERSION="20.04.2 LTS (Focal Fossa)"
```
„Åì„Çå„ÅßDocker„ÅÆÂãï‰Ωú„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åó„Åü„ÄÇ

„Åì„ÅÆ„Ç≥„É≥„ÉÜ„Éä„ÅØ‰∏çË¶Å„Å™„ÅÆ„Åß‰∏ÄÊó¶„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂê´„ÇÅ„Å¶ÂâäÈô§„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ

```
$ docker system prune -a
```

# „Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„ÅÆÂÆüÁèæ

ÂêçÂâç„Å†„ÅëËÅû„Åè„Å®Èõ£„Åó„Åù„ÅÜ„Å™„Ç§„É°„Éº„Ç∏„Åß„Åô„Åå„ÄÅÁ∞°Âçò„Å´„Åæ„Å®„ÇÅ„Çã„Å®

+ Êú¨Êù•Ë§áÊï∞„ÅÆDockerfile„ÅåÂøÖË¶Å„Å™Â†¥Âêà„Å´ÂØæ„Åó„Å¶„ÄÅ‰∏Ä„Å§„ÅÆDockerfile„Åã„ÇâË§áÊï∞„ÅÆ„Ç§„É°„Éº„Ç∏Build„Åå„Åß„Åç„Çã
+ From„Çí„Éà„É™„Ç¨„Éº„Å®„Åó„Å¶‰ΩúÁî®„Åï„Åõ„ÄÅË§áÊï∞„Çπ„ÉÜ„Éº„Ç∏„ÅÆÁîüÊàêÁâ©„ÇíÁ∂ôÊâø„Åß„Åç„Çã„Å®„ÅÑ„ÅÜ„Åì„Å®

„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„Åô„ÄÅ„É°„É™„ÉÉ„Éà„Å®„Åó„Å¶„ÅØ„ÄÅË§áÊï∞„ÅÆ„Ç≥„É≥„ÉÜ„Éä„Çí‰∏Ä„Å§„ÅÆDockerfile„ÅßÁÆ°ÁêÜ„Åß„Åç„Çã„Åì„Å®„Åß„Åô„ÄÇ

„Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„ÅÆË®≠ÂÆö„ÅÆÂâç„Å´„ÄÅ„Åæ„Åö„Éï„Ç°„Ç§„É´ÊßãÊàê„ÇíÊ±∫„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ


```bash:local
 gotail
 ‚îú‚îÄ‚îÄ .github
 ‚îÇ    ‚îî‚îÄ‚îÄ workflows
 ‚îÇ        ‚îî‚îÄ‚îÄ go.yml
 ‚îú‚îÄ‚îÄ README.md
 ‚îú‚îÄ‚îÄ Dockerfile
 ‚îú‚îÄ‚îÄ Makefile
 ‚îú‚îÄ‚îÄ main.go
 ‚îú‚îÄ‚îÄ main_test.go
 ‚îú‚îÄ‚îÄ test.txt
 ‚îú‚îÄ‚îÄ cmd.sh
 ‚îî‚îÄ‚îÄ covercheck.sh
```

Ê¨°„Å´„Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„Å´„Åä„Åë„Çã„ÄÅ„Ç≥„É≥„ÉÜ„Éä„ÉºÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´ÊßãÊàê„ÇíËÄÉ„Åà„Å¶„Åø„Çã„ÄÇ

### „Ç≥„É≥„ÉÜ„Éä1:go

```bash:stage1
 go
 ‚îî‚îÄ‚îÄ src
     ‚îú‚îÄ‚îÄ main.go
     ‚îú‚îÄ‚îÄ main_test.go
     ‚îú‚îÄ‚îÄ test.txt
     ‚îî‚îÄ‚îÄ cmd.sh
```

### „Ç≥„É≥„ÉÜ„Éä2:alpine linux
```bash:stage2
 root
 ‚îú‚îÄ‚îÄ main
 ‚îú‚îÄ‚îÄ test.txt
 ‚îî‚îÄ‚îÄ cmd.sh
```

‰∏äË®ò„ÅÆ„Çà„ÅÜ„Å™„Éï„Ç°„Ç§„É´ÊßãÊàê„ÅÆ„Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„ÇíÂÆüÁèæ„Åô„Çã„Å´„ÅØÊ¨°„ÅÆ„Çà„ÅÜ„Å´Ë®òËø∞„Åó„Åæ„Åô„ÄÇ

```docker:/local/Dockerfile
FROM golang:latest
WORKDIR /go/src
COPY main.go .
COPY main_test.go .
COPY test.txt .
COPY cmd.sh .
RUN go test main_test.go main.go -v
RUN go build main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates && \
    apk add bash
WORKDIR /root
COPY --from=0 /go/src/main .
COPY --from=0 /go/src/test.txt .
COPY --from=0 /go/src/cmd.sh .
CMD ["./cmd.sh"]
```

‰ª•‰∏ä„Åß„Éû„É´„ÉÅ„Çπ„ÉÜ„Éº„Ç∏„Éì„É´„Éâ„ÅØÂÆå‰∫Ü„Åß„Åô„ÄÇ

Ë©≥„Åó„Åè„ÅØÂÖ¨Âºè„Çµ„Ç§„Éà„Çí„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
https://docs.docker.com/develop/develop-images/multistage-build/

# Â§ß„Åæ„Åã„Å™‰ªïÊßò„ÇíÊ±∫„ÇÅ„Çã

‰ªäÂõû„ÅØtail„Ç≥„Éû„É≥„Éâ„ÅÆ„Éá„Éï„Ç©„É´„Éà„ÅÆÂãï‰Ωú„Å®„ÄÅ-n„Ç™„Éó„Ç∑„Éß„É≥„ÅÆÊ©üËÉΩ„ÇíÂÆüË£Ö„Åó„Åü„ÅÑ„Å®ÊÄù„ÅÜ„ÄÇ

### tail„Å®„ÅØ
„Éï„Ç°„Ç§„É´„ÅÆÊúÄÁµÇË°å„Åã„ÇâÊï∞Ë°å„ÇíË°®Á§∫„Åô„Çã„Ç≥„Éû„É≥„Éâ„ÄÅ Ê®ôÊ∫ñ„Åß„ÅØÔºëÔºêË°å„ÇíË°®Á§∫„Åô„Çã„ÄÇ

```
tail 
„Ç™„Éó„Ç∑„Éß„É≥ -n
Âá∫Âäõ„Åô„ÇãË°åÊï∞„ÇíÊåáÂÆö„Åô„Çã
```

„Åæ„Åü„ÄÅ-n„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂÆüÁèæ„Åô„Çã„Åü„ÇÅ„Å´„ÄÅFIFO„Ç¢„É´„Ç¥„É™„Ç∫„É†„Çí‰Ωø„Å£„Å¶ÂÆüË£Ö„Åô„Çã„ÄÇ

## FIFO„Å®„ÅØ

FIFO„Å®„ÅØ„ÄÅFirst In First Out„ÅÆÁï•Áß∞„Åß„Åô„ÄÇ
FIFO„ÇíÁî®„ÅÑ„Çã„Åì„Å®„Å´„Çà„Å£„Å¶„ÄÅÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Çí„É°„É¢„É™„Å´Ê†ºÁ¥ç„Åô„Çã„Åì„Å®„Å™„Åè„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ

Wiki„Å´Ë©≥„Åó„ÅèËºâ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ
https://ja.wikipedia.org/wiki/FIFO

„Åì„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Çí‰Ωø„Å£„Å¶tail„ÇíÂÆüÁèæ„Åó„Åæ„Åô„ÄÇ

## ‰ΩøÁî®„Åô„Çã„É©„Ç§„Éñ„É©„É™

„Ç≥„Éû„É≥„ÉâÊú¨‰Ωì„ÅÆ„É©„Ç§„Éñ„É©„É™‰∏ÄË¶ß
```go:main.go
import (
	"bufio"
	"flag"
	"fmt"
	"math"
	"os"
)
```

test„ÅÆ„É©„Ç§„Éñ„É©„É™‰∏ÄË¶ß
```go:main_test.go
import (
	"bufio"
	"fmt"
	"os"
	"reflect"
	"strconv"
	"testing"
)
```

„Åæ„Åö„ÄÅÂàù„ÇÅ„ÅØ„Ç§„É°„Éº„Ç∏„Åó„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´Á¥∞„Åã„ÅèÂÆüË£Ö„Åó„Åæ„Åô„ÄÇ

„Ç≠„É•„Éº„ÅÆÂàùÊúüÂåñ
```go:init_queue
func init_queue() ([]string, int) {
	queue := []string{}
	cursor := 0
	return queue, cursor
}
```

„Ç®„É≥„Ç≠„É•„Éº
```go:enqueue
func enqueue(queue []string, value string) []string {
	queue = append(queue, value)
	return queue
}
```

„Éá„Ç≠„É•„Éº
```go:dequeue
func dequeue(queue []string) []string {
	queue = queue[1:]
	return queue
}
```

„Ç≠„É•„Éº„ÅÆÂèñ„ÇäÂá∫„Åó
```go:show_queue
func show_queue(queue []string, n int) []string {
	if len(queue) == n {
		for i := n; i > 0; i-- {
			if len(queue) != 0 {
				fmt.Println(queue[0])
			}
			queue = dequeue(queue)
		}
	} else {
		for i := len(queue); i > 0; i-- {
			if len(queue) != 0 {
				fmt.Println(queue[0])
			}
			queue = dequeue(queue)
		}
	}
	return queue
}
```

‰∏ÄÈÄ£„ÅÆÊµÅ„Çå„Çítail„Å®„Åó„Å¶ÂÆöÁæ©
```go:tail
func tail(stream *os.File, err error, n int) []string {
	queue, cursor := init_queue()
	scanner := bufio.NewScanner(stream)
	for scanner.Scan() {
		if n < 1 {
			n = int(math.Abs(float64(n)))
			if n == 0 {
				n = 10
			}
		}
		queue = enqueue(queue, scanner.Text())
		if n-1 < cursor {
			queue = dequeue(queue)
		}
		cursor++
	}
	return queue
}
```

ÂÆüË°å„Åó„Å¶„Åø„Çã„Å®„Åì„ÅÆ„Çà„ÅÜ„Å™ÊÑü„Åò„Å´„Å™„Çä„Åæ„Åô„ÄÇ‚Äª„Åì„Åì„Åß„ÅØ„Çè„Åã„Çä„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´queue„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
`test.txt`„Å´„ÅØ1~100„ÅÆÈÄ£Áï™„Åå‰∏ÄË°å„Åö„Å§ÂÖ•„Å£„Å¶„ÅÑ„Çã„Éï„Ç°„Ç§„É´„Åß„Åô„ÄÇ

```bash:bash
for i in `seq 100` do
for> echo $i >> test.txt
```

```go:main.go
$ go run main.go test.txt
[1]
[1 2]
[1 2 3]
[1 2 3 4]
[1 2 3 4 5]
[1 2 3 4 5 6]
[1 2 3 4 5 6 7]
[1 2 3 4 5 6 7 8]
[1 2 3 4 5 6 7 8 9]
[1 2 3 4 5 6 7 8 9 10]
[1 2 3 4 5 6 7 8 9 10 11]
[2 3 4 5 6 7 8 9 10 11 12]
[3 4 5 6 7 8 9 10 11 12 13]
[4 5 6 7 8 9 10 11 12 13 14]
[5 6 7 8 9 10 11 12 13 14 15]
[6 7 8 9 10 11 12 13 14 15 16]
[7 8 9 10 11 12 13 14 15 16 17]
[8 9 10 11 12 13 14 15 16 17 18]
[9 10 11 12 13 14 15 16 17 18 19]
[10 11 12 13 14 15 16 17 18 19 20]
[11 12 13 14 15 16 17 18 19 20 21]
[12 13 14 15 16 17 18 19 20 21 22]
[13 14 15 16 17 18 19 20 21 22 23]
[14 15 16 17 18 19 20 21 22 23 24]
[15 16 17 18 19 20 21 22 23 24 25]
[16 17 18 19 20 21 22 23 24 25 26]
[17 18 19 20 21 22 23 24 25 26 27]
[18 19 20 21 22 23 24 25 26 27 28]
[19 20 21 22 23 24 25 26 27 28 29]
[20 21 22 23 24 25 26 27 28 29 30]
[21 22 23 24 25 26 27 28 29 30 31]
[22 23 24 25 26 27 28 29 30 31 32]
[23 24 25 26 27 28 29 30 31 32 33]
[24 25 26 27 28 29 30 31 32 33 34]
[25 26 27 28 29 30 31 32 33 34 35]
[26 27 28 29 30 31 32 33 34 35 36]
[27 28 29 30 31 32 33 34 35 36 37]
[28 29 30 31 32 33 34 35 36 37 38]
[29 30 31 32 33 34 35 36 37 38 39]
[30 31 32 33 34 35 36 37 38 39 40]
[31 32 33 34 35 36 37 38 39 40 41]
[32 33 34 35 36 37 38 39 40 41 42]
[33 34 35 36 37 38 39 40 41 42 43]
[34 35 36 37 38 39 40 41 42 43 44]
[35 36 37 38 39 40 41 42 43 44 45]
[36 37 38 39 40 41 42 43 44 45 46]
[37 38 39 40 41 42 43 44 45 46 47]
[38 39 40 41 42 43 44 45 46 47 48]
[39 40 41 42 43 44 45 46 47 48 49]
[40 41 42 43 44 45 46 47 48 49 50]
[41 42 43 44 45 46 47 48 49 50 51]
[42 43 44 45 46 47 48 49 50 51 52]
[43 44 45 46 47 48 49 50 51 52 53]
[44 45 46 47 48 49 50 51 52 53 54]
[45 46 47 48 49 50 51 52 53 54 55]
[46 47 48 49 50 51 52 53 54 55 56]
[47 48 49 50 51 52 53 54 55 56 57]
[48 49 50 51 52 53 54 55 56 57 58]
[49 50 51 52 53 54 55 56 57 58 59]
[50 51 52 53 54 55 56 57 58 59 60]
[51 52 53 54 55 56 57 58 59 60 61]
[52 53 54 55 56 57 58 59 60 61 62]
[53 54 55 56 57 58 59 60 61 62 63]
[54 55 56 57 58 59 60 61 62 63 64]
[55 56 57 58 59 60 61 62 63 64 65]
[56 57 58 59 60 61 62 63 64 65 66]
[57 58 59 60 61 62 63 64 65 66 67]
[58 59 60 61 62 63 64 65 66 67 68]
[59 60 61 62 63 64 65 66 67 68 69]
[60 61 62 63 64 65 66 67 68 69 70]
[61 62 63 64 65 66 67 68 69 70 71]
[62 63 64 65 66 67 68 69 70 71 72]
[63 64 65 66 67 68 69 70 71 72 73]
[64 65 66 67 68 69 70 71 72 73 74]
[65 66 67 68 69 70 71 72 73 74 75]
[66 67 68 69 70 71 72 73 74 75 76]
[67 68 69 70 71 72 73 74 75 76 77]
[68 69 70 71 72 73 74 75 76 77 78]
[69 70 71 72 73 74 75 76 77 78 79]
[70 71 72 73 74 75 76 77 78 79 80]
[71 72 73 74 75 76 77 78 79 80 81]
[72 73 74 75 76 77 78 79 80 81 82]
[73 74 75 76 77 78 79 80 81 82 83]
[74 75 76 77 78 79 80 81 82 83 84]
[75 76 77 78 79 80 81 82 83 84 85]
[76 77 78 79 80 81 82 83 84 85 86]
[77 78 79 80 81 82 83 84 85 86 87]
[78 79 80 81 82 83 84 85 86 87 88]
[79 80 81 82 83 84 85 86 87 88 89]
[80 81 82 83 84 85 86 87 88 89 90]
[81 82 83 84 85 86 87 88 89 90 91]
[82 83 84 85 86 87 88 89 90 91 92]
[83 84 85 86 87 88 89 90 91 92 93]
[84 85 86 87 88 89 90 91 92 93 94]
[85 86 87 88 89 90 91 92 93 94 95]
[86 87 88 89 90 91 92 93 94 95 96]
[87 88 89 90 91 92 93 94 95 96 97]
[88 89 90 91 92 93 94 95 96 97 98]
[89 90 91 92 93 94 95 96 97 98 99]
[90 91 92 93 94 95 96 97 98 99 100]
91
92
93
94
95
96
97
98
99
100
```

Ê¨°„Å´„Ç§„É°„Éº„Ç∏„Åå„Åß„Åç„Åü„Çâ„ÄÅ„É™„Éï„Ç°„ÇØ„Çø„É™„É≥„Ç∞„ÇíË°å„ÅÜ
Èñ¢Êï∞„Çí„Åß„Åç„Çã„Å†„Åë„Åæ„Å®„ÇÅ„Å¶„Åø„Çã„ÄÇ

```go:tail
func tail(stream *os.File, n int) []string {
	queue := []string{}
	scanner := bufio.NewScanner(stream)
	for scanner.Scan() {
		queue = append(queue, scanner.Text())
		if n <= len(queue)-1 {
			queue = queue[1:]
		}
	}
	return queue
}

func show(queues []string) {
	for _, queue := range queues {
		fmt.Println(queue)
	}
}
```

## ÂºïÊï∞„ÄÅflag„ÇíË®≠ÂÆö„Åô„Çã

main„Å´„ÅØ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Å†„Çä„ÄÅÊ®ôÊ∫ñÂÖ•Âäõ„ÇíË™≠„ÇÄÂá¶ÁêÜ„ÇÑ„ÄÅ„Ç™„Éó„Ç∑„Éß„É≥„Éï„É©„Ç∞„Çí„Éë„Éº„Çπ„Åô„ÇãÂá¶ÁêÜ„ÇíÊõ∏„Åç„Åæ„Åô„ÄÇ
Ë§áÊï∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄÂøÖË¶Å„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ„Åù„ÅÆÂá¶ÁêÜ„ÇÇÊõ∏„Åç„Åæ„Åô„ÄÇ

```go:main
func main() {
	const USAGE string = "Usage: gotail [-n #] [file]"
	intOpt := flag.Int("n", 10, USAGE)
	flag.Usage = func() {
		fmt.Println(USAGE)
	}
	flag.Parse()
	n := int(math.Abs(float64(*intOpt)))
	if flag.NArg() > 0 {
		for i := 0; i < flag.NArg(); i++ {
			if i > 0 {
				fmt.Print("\n")
			}
			if flag.NArg() != 1 {
				fmt.Println("==> " + flag.Arg(i) + " <==")
			}
			fp, err := os.Open(flag.Arg(i))
			if err != nil {
				fmt.Println("Error: No such file or directory")
				os.Exit(1)
			}
			defer fp.Close()
			show(tail(fp, n))
		}
	} else {
		show(tail(os.Stdin, n))
	}
}
```

# „É¶„Éã„ÉÉ„Éà„ÉÜ„Çπ„Éà
Ê¨°„Å´„ÉÜ„Çπ„Éà„ÇíÊõ∏„Åè„ÄÇ
„Åì„Åì„Åß„ÅØ„ÄÅ„ÅÇ„Çâ„Åã„Åò„ÇÅÁî®ÊÑè„Åó„Å¶„ÅÑ„Çã`test.txt`„ÇíË™≠„ÅøËæº„Çì„ÅßÊ§úË®º„Åô„Çã„ÄÇ
„Åæ„Åü„ÄÅ„Éï„Ç°„Ç§„É´„Å´ÂØæ„Åó„Å¶ËÄÉ„Åà„ÅÜ„Çã„Ç™„Éó„Ç∑„Éß„É≥„Çí‰∏ÄÈÄö„ÇäË©¶Ë°å„Åß„Åç„Çã„Çà„ÅÜ„Å´„ÉÜ„Çπ„Éà„Åô„Çã„ÄÇ
‰ªäÂõû„ÅØ`test.txt`„ÅØ100Ë°å„ÅÆÈÄ£Áï™Êï∞Â≠ó„ÅÆ„Éá„Éº„Çø„Åß„ÄÅ`-n 1 ~ -n 100`„Åæ„ÅßÈ†Ü„Å´„ÉÜ„Çπ„Éà„Åó„Å¶„ÅÑ„Åè„ÄÇ

```go:testTail
func TestTail(t *testing.T) {
	var actual_all []string
	var expected_all []string
	count := 0
	fp, err := os.Open("./test.txt")
	if err != nil {
		fmt.Println("Error: No such file or directory")
		os.Exit(1)
	}
	defer fp.Close()
	scanner := bufio.NewScanner(fp)
	for scanner.Scan() {
		count++
	}
	n_all := 1
	for i := count; i > 0; i-- {
		fp, err = os.Open("./test.txt")
		actual_all = tail(fp, n_all)
		expected_all = append([]string{strconv.Itoa(i)}, expected_all...)
		if reflect.DeepEqual(actual_all, expected_all) {
			t.Log(reflect.DeepEqual(actual_all, expected_all))
		} else {
			t.Errorf("got %v\nwant %v", actual_all, expected_all)
		}
		n_all++
	}
}
```

# „ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆÁ¢∫Ë™ç
„Åæ„Åü„ÄÅ„ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇíÁ¢∫Ë™ç„Åô„Çã„ÄÇ
Ê¨°„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅßÁ¢∫Ë™ç„Åß„Åç„Çã„ÄÇ
„É¶„Éº„Ç∂„Éº„Åå‰ΩøÁî®„Åß„Åç„Çã„É™„ÇΩ„Éº„Çπ„ÅåÂà∂Èôê„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ
`$ ulimit -a`„ÅßÁ¢∫Ë™ç„Åô„Çã„ÄÇÂøÖË¶Å„Å´Âøú„Åò„Å¶`$ ulimit -n 500`Á≠â„ÇíÂÆüË°å„Åó„Çà„ÅÜ„ÄÇ

```go:testcover
$ go test main_test.go main.go -coverprofile=cover.out
$ go tool cover -html=cover.out -o cover.html
$ open cover.html
```

„Åì„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅßÁ¢∫Ë™ç„Åß„Åç„Çã„ÄÇ

![](https://storage.googleapis.com/zenn-user-upload/i304n67xlsoyvxcgoad67imia3hm)

„Å†„ÅÑ„Åü„ÅÑ8Ââ≤„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„ÅÆ„ÅßÊ¨°„Å´ÈÄ≤„ÇÄ„ÄÇ

docker„ÇíÁ´ã„Å°‰∏ä„Åí„Å¶build„ÇíÂÆüË°å„Åó„Å¶„Åø„Çã„ÄÇ
ÂÖàÁ®ã„ÅÆDockerfile„ÅÆË®≠ÂÆö„Å´„Çà„Å£„Å¶„ÄÅtest„ÅÆÂÆüÊñΩ„ÇÇË°å„ÅÜ„ÄÇ
cmd.sh„Å´„ÄÅstage2„ÅßÂÆüË°å„Åó„Åü„ÅÑ„Ç≥„Éû„É≥„Éâ„ÇíË®òËø∞„Åó„Çà„ÅÜ„ÄÇ

```bash:cmd.sh
#!/bin/sh -eux
./main < test.txt
```

Ë®òËø∞„Åß„Åç„Åü„Çâ„ÄÅ„Ç≥„É≥„ÉÜ„Éä„Éº„ÇíËµ∑Âãï„Åô„Çã„ÄÇ
„Ç≥„Éû„É≥„Éâ„Çí„ÅÑ„Å°„ÅÑ„Å°Êâì„Å§„ÅÆ„ÅØÈù¢ÂÄí„Å™„ÅÆ„Åß„ÄÅMakefile„Åß„Ç≥„Éû„É≥„Éâ„ÇíÂçòÁ¥îÂåñ„Åô„Çã„ÄÇ

```bash:Makefile
NAME := gotail

.PHONY: all
all: docker-build docker-run

.PHONY: docker-build
docker-build:
	docker build -t $(NAME) .

.PHONY: docker-run
docker-run:
	docker run --rm $(NAME)
```

```bash
$ make
```

„Åì„Çå„Åß„ÄÅ‰∏ÄÈÄ£„ÅÆÂÆüË°å„ÅåÁ¢∫Ë™ç„Åß„Åç„Çå„Å∞OK„Åß„Åô„ÄÇ

# GitHub Actions„Å´„Çà„ÇãCI/CD(Go,Docker)

GitHub Actions„Åß„ÅØGitHub‰∏ä„Åßtest„ÇíËµ∞„Çâ„Åõ„Åü„Çä„ÄÅbuild„Çí„Åó„Åü„Çä„Åß„Åç„Çã„ÅÆ„ÅßÂ§ßÂ§â‰æøÂà©„Åß„Åô„ÄÇ
‰ªäÂõû„ÅØgoÂçò‰Ωì„ÅßÊ§úË®º„Åô„ÇãAction„Å®Docker„ÇíËµ∑Âãï„Åô„ÇãAction„ÇíË©¶„Åó„Å¶„Åø„Çã„ÄÇ

„Åæ„Åö„ÄÅÊ¨°„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÊàê„Å´„Åó„Å¶„Åä„ÅèÂøÖË¶Å„Åå„ÅÇ„Çã„ÄÇ

```
 gotail
 ‚îî‚îÄ.github
    ‚îî‚îÄ‚îÄ workflows
        ‚îî‚îÄ‚îÄ go.yml
```

Action„ÅÆË®≠ÂÆö„ÅØYAML„Éï„Ç°„Ç§„É´„ÅßË®òËø∞„Åô„Çã„ÄÇ
„Åæ„Åö„ÅØ„ÄÅgo.yml„ÇíË®òËø∞„Åó„Çà„ÅÜ„ÄÇ

```yaml:go.yml
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15

    - name: Build
      run: go build -v ./main.go

    - name: Test
      run: go test -v ./main_test.go main.go
```

ÂØæË±°„ÅÆ„Éñ„É©„É≥„ÉÅ‰∏ä„Å∏push„Å®pullrequest„ÇíË°å„Å£„ÅüÈöõ„Å´„ÄÅAction„ÅåËµ∞„ÇãË®≠ÂÆö„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ
„Åæ„Åü„ÄÅbuild„Å®test„ÇíÂÆüË°å„Åß„Åç„Çã„ÄÇ

Ê¨°„Å´docker„ÅÆËµ∑Âãï„ÇÇË©¶„Åó„Å¶„Åø„Çã„ÄÇ

```
 gotail
 ‚îî‚îÄ.github
    ‚îî‚îÄ‚îÄ workflows
        ‚îî‚îÄ‚îÄ docker.yml
```

```yaml:docker.yml
name: CI to Docker Hub
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Check Out Repo
              uses: actions/checkout@v2
            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v1
            - name: Build and push
              id: docker_build
              uses: docker/build-push-action@v2
              with:
                    context: ./
                    file: ./Dockerfile
                    push: true
                    tags: ${{ secrets.DOCKER_HUB_USERNAME }}/simplewhale:latest
            - name: Image digest
              run: echo ${{ steps.docker_build.outputs.digest }}

            - name: Run
              run: make
```

„Åì„ÅÆsecrets„ÅØGithub„ÇÑDockerhub‰∏ä„Åß„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
„Åæ„Åö„ÄÅDocker Hub„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Åæ„Åô„ÄÇ

https://hub.docker.com/

„Çµ„Ç§„É≥„Ç§„É≥„Åå„Åß„Åç„Åü„Çâ„ÄÅÊ¨°„Å´Âè≥‰∏ä„Å´„ÅÇ„Çã„Ç¢„Ç§„Ç≥„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅ„É°„Éã„É•„Éº„ÇíË°®Á§∫„ÄÅ‰ª•‰∏ã„ÅÆÈ†ÖÁõÆ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åæ„Åô„ÄÇ
![](https://storage.googleapis.com/zenn-user-upload/qjssrgpbrr8fxcyi4eliuhyt1sr9)

Ê¨°„Å´„ÄÅSecurity‚ÜíNew Access Token„ÅÆÈ†Ü„Å´„ÇØ„É™„ÉÉ„ÇØ„ÄÇ

![](https://storage.googleapis.com/zenn-user-upload/nso8p6lzjcn83l1rk9y65hhr6kpx)

Token„ÅåË°®Á§∫„Åï„Çå„Çã„ÅÆ„Åß„ÄÅÈÅ©ÂΩì„Å´title„Å™„Å©„ÇíÂÖ•Âäõ„Åó„ÄÅCopy„Åó„Å¶„Ç¶„Ç§„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Åæ„Åô„ÄÇ

![](https://storage.googleapis.com/zenn-user-upload/4fyfvf8oohf87br3s9vmcthkn9vr)

Ê¨°„Å´Github„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Åæ„Åô„ÄÇ

https://github.com/

Setting‚ÜíSecret‚ÜíNew repository secret„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åù„Çå„Åû„ÇåÂÖàÁ®ã„ÅÆToken„ÇÑDocker Hub„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ

![](https://storage.googleapis.com/zenn-user-upload/yxvr3kk28w5nngzjpsnq6f2idfsc)
![](https://storage.googleapis.com/zenn-user-upload/5cyavidzcj7xagc3zwe5zaaetr13)
![](https://storage.googleapis.com/zenn-user-upload/214pnbq0ffx12tyymyn9jcmal0aw)

‰ª•‰∏ä„ÅßË®≠ÂÆö„ÅØÂÆå‰∫Ü„Åß„Åô„ÄÇ
ÊúÄÂæå„Å´„É™„Éù„Ç∏„Éà„É™„Å´push„Åãpullrequest„ÇíË°å„ÅÜ„Å®Ëá™Âãï„ÅßAction„ÅåÂÆüË°å„Åï„Çå„Åæ„Åô„ÄÇ

‰ªäÂõû„ÅÆ„Ç≥„Éº„ÉâÁ≠â„ÅØ„ÄÅ„Åì„ÅÆË®ò‰∫ã„ÇíÂü∑Á≠Ü„Åó„Å¶„ÅÑ„ÇãÊÆµÈöé„Åß„ÅØ„ÄÅ„Åæ„Å†master„Å´„Éû„Éº„Ç∏„ÅØ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅGithub„Å´„ÇÇ„Ç¢„ÉÉ„Éó„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÂèÇËÄÉ„Å´„Å™„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÅ„É™„É≥„ÇØË≤º„Å£„Å¶„Åä„Åç„Åæ„Åô„ÄÇ
https://github.com/Iovesophy/gotail

# „Åæ„Å®„ÇÅ
„ÅäÁñ≤„ÇåÊßò„Åß„Åó„Åü„ÄÅ„Åì„Åì„Åæ„ÅßË™≠„Çì„Åß„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ
GoË®ÄË™û„ÅØÂàù„ÇÅ„Å¶„Åß„Åó„Åü„Åå„ÄÅGoË®ÄË™û„ÅÆ„É°„É™„ÉÉ„Éà„Å®„Åó„Å¶„Çà„ÅèÊåô„Åí„Çâ„Çå„Çã„ÄÅÂàùÂøÉËÄÖ„Åß„ÇÇÁêÜËß£„Åó„ÇÑ„Åô„ÅÑ„ÄÅÂá¶ÁêÜ„ÅÆÈÄüÂ∫¶„ÅåÈÄü„ÅÑ„ÄÅÂ∞ë„Å™„ÅÑ„Ç≥„Éº„ÉâÂÆüË£Ö„Åß„Åç„Çã„ÄÅ„É©„Ç§„Éñ„É©„É™„ÅåË±äÂØå„ÄÅ‰∏¶Ë°åÂá¶ÁêÜ„ÅåÂèØËÉΩ„ÄÅÂÆâÂÖ®ÊÄß„ÅåÈ´ò„ÅÑ„Å®„ÅÑ„ÅÜ„ÅÆ„ÅØ„Åæ„Åï„Å´„Åù„ÅÆÈÄö„Çä„Åß„ÅÇ„Çã„Å®ÊÑü„Åò„Åæ„Åó„Åü„ÄÇ
Ê¨°„ÅØÁ∞°Âçò„Å™„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Âà∂‰Ωú„ÇÑ‰∏¶Ë°åÂá¶ÁêÜ„ÇíË©¶„Åó„Å¶„Åø„Åü„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ
